<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Karokh's CI/CD Test Pipeline Manager - With Real Execution</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <!-- Load Pyodide for Python execution -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
        }
        .code-area {
            font-family: 'Consolas', 'Monaco', monospace;
            min-height: 200px;
        }
        .modal-open {
            overflow: hidden;
        }
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid white;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 p-4 sm:p-8">

    <div id="app" class="max-w-6xl mx-auto">
        <header class="mb-8 flex flex-col sm:flex-row justify-between items-center pb-4 border-b border-gray-700">
            <h1 class="text-4xl font-extrabold text-emerald-400 mb-4 sm:mb-0">Karokh's Pipeline Test Manager</h1>
            <div class="flex space-x-3 flex-wrap gap-2">
                <button onclick="openExecutionSettingsModal()"
                    class="bg-orange-600 hover:bg-orange-500 text-white font-semibold py-2 px-4 rounded-lg shadow-lg transition duration-200">
                    Execution Settings
                </button>
                <button onclick="openSettingsModal()"
                    class="bg-purple-600 hover:bg-purple-500 text-white font-semibold py-2 px-4 rounded-lg shadow-lg transition duration-200">
                    Storage Settings
                </button>
                <button onclick="openAddSuiteModal()"
                    class="bg-emerald-600 hover:bg-emerald-500 text-white font-semibold py-2 px-4 rounded-lg shadow-lg transition duration-200">
                    + Add New Test Suite
                </button>
                
                <label for="import-file-input" class="bg-sky-600 hover:bg-sky-500 text-white font-semibold py-2 px-4 rounded-lg shadow-lg transition duration-200 cursor-pointer flex items-center">
                    Import JSON
                </label>
                <input type="file" id="import-file-input" class="hidden" accept=".json" onchange="importFromJSON(event)">
                
                <button onclick="exportToJSON()"
                    class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg shadow-lg transition duration-200">
                    Export JSON
                </button>
            </div>
        </header>

        <div id="storage-status" class="text-sm mb-4 p-3 bg-gray-800 rounded-lg shadow-inner">
            <p id="storage-info">Initializing storage...</p>
        </div>

        <div id="execution-status" class="text-sm mb-4 p-3 bg-gray-800 rounded-lg shadow-inner border-l-4 border-orange-500">
            <p id="execution-info">Execution Mode: <span id="exec-mode-display" class="font-semibold">Loading...</span></p>
        </div>

        <main id="suite-list-container">
            <h2 class="text-2xl font-bold mb-4 text-gray-300">Configured Test Suites</h2>
            <div id="test-suites" class="space-y-6">
                <!-- Test suite cards will be rendered here -->
                <p id="loading-message" class="text-gray-500">Loading test suites...</p>
            </div>
        </main>

        <!-- Notification/Message Box -->
        <div id="message-box" class="fixed top-5 right-5 z-50 transition-all duration-300 transform translate-x-full">
        </div>

    </div>

    <!-- Execution Settings Modal -->
    <div id="execution-settings-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70">
        <div class="bg-gray-800 p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto">
            <h3 class="text-3xl font-bold mb-6 text-orange-400">Execution Configuration</h3>
            
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-300 mb-3">Execution Mode</label>
                <div class="space-y-3">
                    <label class="flex items-start p-4 bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-650">
                        <input type="radio" name="execution-mode" value="real" checked class="mt-1 mr-3">
                        <div>
                            <div class="font-semibold text-green-400">Real Execution (Recommended)</div>
                            <div class="text-sm text-gray-400">Actually run your code and see real output. Python runs in browser, Java/C# require API or local compiler.</div>
                        </div>
                    </label>
                    
                    <label class="flex items-start p-4 bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-650">
                        <input type="radio" name="execution-mode" value="simulated" class="mt-1 mr-3">
                        <div>
                            <div class="font-semibold text-yellow-400">Simulated Execution</div>
                            <div class="text-sm text-gray-400">Display code without running it. Useful for planning and documentation.</div>
                        </div>
                    </label>
                </div>
            </div>

            <!-- Python Execution Config -->
            <div id="python-exec-config" class="mb-6 p-4 bg-gray-900 rounded-lg border border-gray-700">
                <h4 class="font-semibold text-blue-400 mb-3">Python Execution</h4>
                <div class="text-sm text-gray-400 mb-2">
                    <span class="text-green-400">✓ Browser-based execution via Pyodide (WebAssembly)</span>
                </div>
                <div class="text-xs text-gray-500">
                    Python code runs directly in your browser. No server needed. First run may take a few seconds to initialize.
                </div>
            </div>

            <!-- Java Execution Config -->
            <div id="java-exec-config" class="mb-6 p-4 bg-gray-900 rounded-lg border border-gray-700">
                <h4 class="font-semibold text-orange-400 mb-3">Java Execution</h4>
                <p class="text-xs text-gray-400 mb-3">Choose how to execute Java code:</p>
                
                <div class="space-y-2 mb-3">
                    <label class="flex items-center">
                        <input type="radio" name="java-execution-type" value="jdoodle" checked class="mr-2">
                        <span class="text-sm">JDoodle API (requires free API key from jdoodle.com)</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="java-execution-type" value="local" class="mr-2">
                        <span class="text-sm">Local compiler (requires Java installed + backend server)</span>
                    </label>
                </div>

                <div id="jdoodle-config">
                    <div class="mb-2">
                        <label class="block text-xs text-gray-400 mb-1">JDoodle Client ID</label>
                        <input type="text" id="jdoodle-client-id" placeholder="Get from jdoodle.com" 
                            class="w-full bg-gray-800 border border-gray-600 text-white p-2 rounded text-sm">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">JDoodle Client Secret</label>
                        <input type="text" id="jdoodle-client-secret" placeholder="Get from jdoodle.com" 
                            class="w-full bg-gray-800 border border-gray-600 text-white p-2 rounded text-sm">
                    </div>
                    <a href="https://www.jdoodle.com/compiler-api" target="_blank" 
                        class="text-xs text-blue-400 hover:underline mt-1 inline-block">
                        → Get free API key (200 requests/day)
                    </a>
                </div>
            </div>

            <!-- C# Execution Config -->
            <div id="csharp-exec-config" class="mb-6 p-4 bg-gray-900 rounded-lg border border-gray-700">
                <h4 class="font-semibold text-purple-400 mb-3">C# Execution</h4>
                <p class="text-xs text-gray-400 mb-3">Choose how to execute C# code:</p>
                
                <div class="space-y-2 mb-3">
                    <label class="flex items-center">
                        <input type="radio" name="csharp-execution-type" value="jdoodle" checked class="mr-2">
                        <span class="text-sm">JDoodle API (same credentials as Java)</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="csharp-execution-type" value="local" class="mr-2">
                        <span class="text-sm">Local compiler (requires .NET/Mono + backend server)</span>
                    </label>
                </div>
            </div>

            <div class="flex justify-end space-x-3">
                <button type="button" onclick="closeExecutionSettingsModal()"
                    class="bg-gray-600 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                    Cancel
                </button>
                <button type="button" onclick="saveExecutionSettings()"
                    class="bg-orange-600 hover:bg-orange-500 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                    Save Settings
                </button>
            </div>
        </div>
    </div>

    <!-- Storage Settings Modal -->
    <div id="settings-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70">
        <div class="bg-gray-800 p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto">
            <h3 class="text-3xl font-bold mb-6 text-purple-400">Storage Configuration</h3>
            
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-300 mb-3">Storage Backend</label>
                <div class="space-y-3">
                    <label class="flex items-start p-4 bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-650">
                        <input type="radio" name="storage-type" value="localStorage" checked class="mt-1 mr-3">
                        <div>
                            <div class="font-semibold text-emerald-400">Local Storage (Browser)</div>
                            <div class="text-sm text-gray-400">Store data in your browser. Simple, no setup required. Data stays on this device only.</div>
                        </div>
                    </label>
                    
                    <label class="flex items-start p-4 bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-650">
                        <input type="radio" name="storage-type" value="firebase" class="mt-1 mr-3">
                        <div>
                            <div class="font-semibold text-orange-400">Firebase (Google Cloud)</div>
                            <div class="text-sm text-gray-400">Sync data across devices. Requires free Firebase account and credentials.</div>
                        </div>
                    </label>
                    
                    <label class="flex items-start p-4 bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-650">
                        <input type="radio" name="storage-type" value="customApi" class="mt-1 mr-3">
                        <div>
                            <div class="font-semibold text-blue-400">Custom API Backend</div>
                            <div class="text-sm text-gray-400">Connect to your own server/API. Full control over data storage.</div>
                        </div>
                    </label>
                </div>
            </div>

            <!-- Firebase Configuration -->
            <div id="firebase-config" class="hidden mb-6 p-4 bg-gray-900 rounded-lg border border-gray-700">
                <h4 class="font-semibold text-orange-400 mb-3">Firebase Configuration</h4>
                <p class="text-xs text-gray-400 mb-3">Get these values from your Firebase Console → Project Settings → General</p>
                
                <div class="space-y-3">
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">API Key</label>
                        <input type="text" id="firebase-api-key" placeholder="AIzaSy..." class="w-full bg-gray-800 border border-gray-600 text-white p-2 rounded text-sm">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">Auth Domain</label>
                        <input type="text" id="firebase-auth-domain" placeholder="your-app.firebaseapp.com" class="w-full bg-gray-800 border border-gray-600 text-white p-2 rounded text-sm">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">Project ID</label>
                        <input type="text" id="firebase-project-id" placeholder="your-project-id" class="w-full bg-gray-800 border border-gray-600 text-white p-2 rounded text-sm">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">Storage Bucket</label>
                        <input type="text" id="firebase-storage-bucket" placeholder="your-app.appspot.com" class="w-full bg-gray-800 border border-gray-600 text-white p-2 rounded text-sm">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">Messaging Sender ID</label>
                        <input type="text" id="firebase-messaging-sender-id" placeholder="123456789" class="w-full bg-gray-800 border border-gray-600 text-white p-2 rounded text-sm">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">App ID</label>
                        <input type="text" id="firebase-app-id" placeholder="1:123:web:abc" class="w-full bg-gray-800 border border-gray-600 text-white p-2 rounded text-sm">
                    </div>
                </div>
            </div>

            <!-- Custom API Configuration -->
            <div id="custom-api-config" class="hidden mb-6 p-4 bg-gray-900 rounded-lg border border-gray-700">
                <h4 class="font-semibold text-blue-400 mb-3">Custom API Configuration</h4>
                <p class="text-xs text-gray-400 mb-3">Your API should support GET, POST, PUT, and DELETE operations</p>
                
                <div class="space-y-3">
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">API Base URL</label>
                        <input type="text" id="custom-api-url" placeholder="https://api.yourserver.com/test-suites" class="w-full bg-gray-800 border border-gray-600 text-white p-2 rounded text-sm">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">API Key / Authorization Header (Optional)</label>
                        <input type="text" id="custom-api-auth" placeholder="Bearer your-token-here" class="w-full bg-gray-800 border border-gray-600 text-white p-2 rounded text-sm">
                    </div>
                </div>
            </div>

            <div class="flex justify-end space-x-3">
                <button type="button" onclick="closeSettingsModal()"
                    class="bg-gray-600 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                    Cancel
                </button>
                <button type="button" onclick="saveStorageSettings()"
                    class="bg-purple-600 hover:bg-purple-500 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                    Save & Reconnect
                </button>
            </div>
        </div>
    </div>

    <!-- Edit/Add Suite Modal -->
    <div id="editor-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 transition-opacity"
         onclick="if (event.target.id === 'editor-modal') closeEditorModal()">
        <div class="bg-gray-800 p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto transform transition-all duration-300"
             onclick="event.stopPropagation()">
            <h3 id="modal-title" class="text-3xl font-bold mb-6 text-emerald-400">Add New Test Suite</h3>

            <form id="suite-form" onsubmit="handleSave(event)">
                <input type="hidden" id="suite-id">

                <div class="mb-4">
                    <label for="name" class="block text-sm font-medium text-gray-300 mb-1">Suite Name</label>
                    <input type="text" id="name" required class="w-full bg-gray-700 border border-gray-600 text-white p-3 rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                </div>

                <div class="mb-4">
                    <label for="description" class="block text-sm font-medium text-gray-300 mb-1">Description</label>
                    <textarea id="description" rows="2" class="w-full bg-gray-700 border border-gray-600 text-white p-3 rounded-lg focus:ring-emerald-500 focus:border-emerald-500"></textarea>
                </div>

                <div class="mb-4">
                    <label for="language" class="block text-sm font-medium text-gray-300 mb-1">Test Language/Type</label>
                    <select id="language" required class="w-full bg-gray-700 border border-gray-600 text-white p-3 rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                        <option value="Python">Python (Internal Script)</option>
                        <option value="Java">Java (Internal Script)</option>
                        <option value="CSharp">C# (Internal Script)</option>
                        <option value="External">External Script / CLI Call</option>
                    </select>
                </div>

                <div class="mb-4 border-t border-gray-700 pt-4">
                    <label class="block text-sm font-medium text-gray-300 mb-1">Execution Parameters (Key/Value)</label>
                    <p class="text-xs text-gray-500 mb-3">Define dynamic parameters for your simulated test environment.</p>
                    <div id="parameters-container" class="space-y-2">
                        <!-- Parameter inputs will be rendered here by JS -->
                    </div>
                    <button type="button" onclick="addParameterInput()"
                        class="mt-3 text-sm bg-emerald-500 hover:bg-emerald-400 text-white py-1 px-3 rounded-lg transition duration-200">
                        + Add Parameter
                    </button>
                    <input type="hidden" id="parameters-json">
                </div>

                <div class="mb-4 border-t border-gray-700 pt-4">
                    <label class="block text-sm font-medium text-gray-300 mb-1">External Test Inputs (Mock Files)</label>
                    <p class="text-xs text-gray-500 mb-3">Load files from your computer or manually enter content. You can add multiple files.</p>
                    <div id="input-files-container" class="space-y-4">
                        <!-- Dynamic input file groups go here -->
                    </div>
                    <button type="button" onclick="addInputFile()"
                        class="mt-3 text-sm bg-emerald-500 hover:bg-emerald-400 text-white py-1 px-3 rounded-lg transition duration-200">
                        + Add Test Input
                    </button>
                </div>

                <div class="mb-4 border-t border-gray-700 pt-4">
                    <label for="code" class="block text-sm font-medium text-gray-300 mb-1">Internal Test Logic (Code)</label>
                    <p class="text-xs text-gray-500 mb-1">Your test script code (e.g., Python, Java, C# logic).</p>
                    <textarea id="code" rows="8" class="code-area w-full bg-gray-900 border border-gray-600 text-green-400 p-3 rounded-lg focus:ring-emerald-500 focus:border-emerald-500"></textarea>
                </div>

                <div class="mb-4 border-t border-gray-700 pt-4">
                    <label for="webhook_url" class="block text-sm font-medium text-gray-300 mb-1">External Integration / Webhook URL (Optional)</label>
                    <input type="url" id="webhook_url" placeholder="https://your-ci-server/trigger" class="w-full bg-gray-700 border border-gray-600 text-white p-3 rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                </div>

                <div class="mb-6">
                    <label for="integration_info" class="block text-sm font-medium text-gray-300 mb-1">API/Program Integration Details</label>
                    <p class="text-xs text-gray-500 mb-1">Describe external programs or API calls this test would make.</p>
                    <textarea id="integration_info" rows="3" class="w-full bg-gray-700 border border-gray-600 text-white p-3 rounded-lg focus:ring-emerald-500 focus:border-emerald-500"></textarea>
                </div>

                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeEditorModal()"
                        class="bg-gray-600 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                        Cancel
                    </button>
                    <button type="submit"
                        class="bg-emerald-600 hover:bg-emerald-500 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                        Save Test Suite
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Run Modal -->
    <div id="run-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70"
         onclick="if (event.target.id === 'run-modal') closeRunModal()">
        <div class="bg-gray-800 p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto"
             onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h3 id="run-modal-title" class="text-2xl font-bold text-emerald-400">Run Test Suite</h3>
                <div id="run-status-indicator" class="text-sm"></div>
            </div>
            <div id="run-modal-content" class="bg-gray-900 p-4 rounded-lg text-sm font-mono text-green-400 whitespace-pre-wrap max-h-[600px] overflow-y-auto">
                <!-- Log output will be displayed here -->
            </div>
            <div class="mt-4 flex justify-end">
                <button onclick="closeRunModal()"
                    class="bg-gray-600 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK (loaded only when needed) -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        
        // Make Firebase functions available globally
        window.firebaseModules = {
            initializeApp,
            getFirestore,
            collection,
            addDoc,
            updateDoc,
            deleteDoc,
            doc,
            onSnapshot,
            query,
            where,
            getAuth,
            signInAnonymously,
            onAuthStateChanged
        };
    </script>

    <script>
        // ============================================
        // EXECUTION ENGINE
        // ============================================
        
        let pyodideInstance = null;
        let pyodideLoading = false;
        let executionConfig = null;

        async function initializePyodide() {
            if (pyodideInstance) return pyodideInstance;
            if (pyodideLoading) {
                // Wait for existing load
                while (pyodideLoading) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                return pyodideInstance;
            }

            pyodideLoading = true;
            try {
                console.log("Loading Pyodide...");
                pyodideInstance = await loadPyodide({
                    indexURL: "https://cdn.jsdelivr.net/pyodide/v0.24.1/full/"
                });
                console.log("Pyodide loaded successfully");
                pyodideLoading = false;
                return pyodideInstance;
            } catch (error) {
                pyodideLoading = false;
                console.error("Failed to load Pyodide:", error);
                throw error;
            }
        }

        async function executePythonCode(code, inputFiles) {
            try {
                const pyodide = await initializePyodide();
                
                // Get Python's current working directory and write files there
                const cwd = pyodide.runPython('import os; os.getcwd()');
                
                // Create a virtual filesystem with input files in the working directory
                for (const file of inputFiles) {
                    const filePath = `${cwd}/${file.filename}`;
                    pyodide.FS.writeFile(filePath, file.content);
                }
                
                // Capture stdout
                let output = '';
                pyodide.runPython(`
import sys
from io import StringIO
sys.stdout = StringIO()
sys.stderr = StringIO()
`);
                
                // Run the code
                try {
                    await pyodide.runPythonAsync(code);
                    
                    // Get output
                    output = pyodide.runPython(`
stdout_value = sys.stdout.getvalue()
stderr_value = sys.stderr.getvalue()
stdout_value + stderr_value
`);
                } catch (execError) {
                    output = pyodide.runPython(`sys.stderr.getvalue()`) || execError.message;
                    throw new Error(output);
                }
                
                return {
                    success: true,
                    output: output,
                    error: null
                };
                
            } catch (error) {
                return {
                    success: false,
                    output: error.output || '',
                    error: error.message
                };
            }
        }

        async function executeJavaCode(code, inputFiles) {
            if (!executionConfig.javaType || executionConfig.javaType === 'jdoodle') {
                if (!executionConfig.jdoodleClientId || !executionConfig.jdoodleClientSecret) {
                    throw new Error("JDoodle API credentials not configured. Please go to Execution Settings.");
                }
                
                return await executeViaJDoodle('java', code, inputFiles);
            } else {
                throw new Error("Local Java execution requires a backend server. This feature is not yet implemented.");
            }
        }

        async function executeCSharpCode(code, inputFiles) {
            if (!executionConfig.csharpType || executionConfig.csharpType === 'jdoodle') {
                if (!executionConfig.jdoodleClientId || !executionConfig.jdoodleClientSecret) {
                    throw new Error("JDoodle API credentials not configured. Please go to Execution Settings.");
                }
                
                return await executeViaJDoodle('csharp', code, inputFiles);
            } else {
                throw new Error("Local C# execution requires a backend server. This feature is not yet implemented.");
            }
        }

        async function executeViaJDoodle(language, code, inputFiles) {
            // Prepare stdin (concatenate all input files)
            const stdin = inputFiles.map(f => f.content).join('\n');
            
            const payload = {
                clientId: executionConfig.jdoodleClientId,
                clientSecret: executionConfig.jdoodleClientSecret,
                script: code,
                stdin: stdin,
                language: language === 'java' ? 'java' : 'csharp',
                versionIndex: "0"
            };

            try {
                const response = await fetch('https://api.jdoodle.com/v1/execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                
                if (result.error) {
                    return {
                        success: false,
                        output: result.output || '',
                        error: result.error
                    };
                }

                return {
                    success: !result.statusCode || result.statusCode === 200,
                    output: result.output || '',
                    error: result.statusCode && result.statusCode !== 200 ? `Exit code: ${result.statusCode}` : null
                };
            } catch (error) {
                return {
                    success: false,
                    output: '',
                    error: error.message
                };
            }
        }

        function loadExecutionConfig() {
            const saved = localStorage.getItem('execution_config');
            if (saved) {
                executionConfig = JSON.parse(saved);
            } else {
                executionConfig = {
                    mode: 'real',
                    javaType: 'jdoodle',
                    csharpType: 'jdoodle',
                    jdoodleClientId: '',
                    jdoodleClientSecret: ''
                };
            }
            updateExecutionDisplay();
        }

        function updateExecutionDisplay() {
            const modeDisplay = document.getElementById('exec-mode-display');
            if (executionConfig.mode === 'real') {
                modeDisplay.innerHTML = '<span class="text-green-400">Real Execution (Python in browser, Java/C# via API)</span>';
            } else {
                modeDisplay.innerHTML = '<span class="text-yellow-400">Simulated (Display only)</span>';
            }
        }

        // ============================================
        // EXECUTION SETTINGS MODAL
        // ============================================
        
        function openExecutionSettingsModal() {
            // Load current config
            document.querySelector(`input[name="execution-mode"][value="${executionConfig.mode}"]`).checked = true;
            document.querySelector(`input[name="java-execution-type"][value="${executionConfig.javaType}"]`).checked = true;
            document.querySelector(`input[name="csharp-execution-type"][value="${executionConfig.csharpType}"]`).checked = true;
            document.getElementById('jdoodle-client-id').value = executionConfig.jdoodleClientId || '';
            document.getElementById('jdoodle-client-secret').value = executionConfig.jdoodleClientSecret || '';
            
            document.getElementById('execution-settings-modal').classList.remove('hidden');
        }

        function closeExecutionSettingsModal() {
            document.getElementById('execution-settings-modal').classList.add('hidden');
        }

        function saveExecutionSettings() {
            executionConfig.mode = document.querySelector('input[name="execution-mode"]:checked').value;
            executionConfig.javaType = document.querySelector('input[name="java-execution-type"]:checked').value;
            executionConfig.csharpType = document.querySelector('input[name="csharp-execution-type"]:checked').value;
            executionConfig.jdoodleClientId = document.getElementById('jdoodle-client-id').value;
            executionConfig.jdoodleClientSecret = document.getElementById('jdoodle-client-secret').value;
            
            localStorage.setItem('execution_config', JSON.stringify(executionConfig));
            updateExecutionDisplay();
            closeExecutionSettingsModal();
            showMessage("Execution settings saved", 'success');
        }

        // ============================================
        // STORAGE ABSTRACTION LAYER
        // ============================================
        
        let currentStorage = null;
        let storageConfig = null;
        
        // Storage Interface - all backends must implement these methods
        class StorageBackend {
            async initialize() { throw new Error("Not implemented"); }
            async getAllSuites() { throw new Error("Not implemented"); }
            async saveSuite(suite) { throw new Error("Not implemented"); }
            async updateSuite(id, suite) { throw new Error("Not implemented"); }
            async deleteSuite(id) { throw new Error("Not implemented"); }
            async subscribeToChanges(callback) { /* Optional */ }
            getStatusMessage() { return "Connected"; }
        }

        // ============================================
        // LOCAL STORAGE BACKEND
        // ============================================
        
        class LocalStorageBackend extends StorageBackend {
            constructor() {
                super();
                this.STORAGE_KEY = 'pipeline_test_suites';
                this.changeListeners = [];
            }

            async initialize() {
                if (!window.localStorage) {
                    throw new Error("localStorage is not available in this browser");
                }
                return true;
            }

            async getAllSuites() {
                const data = localStorage.getItem(this.STORAGE_KEY);
                return data ? JSON.parse(data) : [];
            }

            async saveSuite(suite) {
                const suites = await this.getAllSuites();
                suite.id = suite.id || this._generateId();
                suite.last_run_time = suite.last_run_time || null;
                suite.last_run_status = suite.last_run_status || 'NEVER_RUN';
                suite.last_run_log = suite.last_run_log || '';
                suites.push(suite);
                localStorage.setItem(this.STORAGE_KEY, JSON.stringify(suites));
                this._notifyListeners();
                return suite.id;
            }

            async updateSuite(id, updates) {
                const suites = await this.getAllSuites();
                const index = suites.findIndex(s => s.id === id);
                if (index !== -1) {
                    suites[index] = { ...suites[index], ...updates };
                    localStorage.setItem(this.STORAGE_KEY, JSON.stringify(suites));
                    this._notifyListeners();
                }
            }

            async deleteSuite(id) {
                const suites = await this.getAllSuites();
                const filtered = suites.filter(s => s.id !== id);
                localStorage.setItem(this.STORAGE_KEY, JSON.stringify(filtered));
                this._notifyListeners();
            }

            async subscribeToChanges(callback) {
                this.changeListeners.push(callback);
                const suites = await this.getAllSuites();
                callback(suites);
            }

            _notifyListeners() {
                const suites = JSON.parse(localStorage.getItem(this.STORAGE_KEY) || '[]');
                this.changeListeners.forEach(cb => cb(suites));
            }

            _generateId() {
                return 'local_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }

            getStatusMessage() {
                return `Connected: Local Storage (Browser Only)`;
            }
        }

        // ============================================
        // FIREBASE BACKEND
        // ============================================
        
        class FirebaseBackend extends StorageBackend {
            constructor(config) {
                super();
                this.config = config;
                this.app = null;
                this.db = null;
                this.auth = null;
                this.userId = null;
                this.unsubscribe = null;
            }

            async initialize() {
                try {
                    if (!window.firebaseModules) {
                        throw new Error("Firebase modules not loaded");
                    }

                    const { initializeApp, getFirestore, getAuth, signInAnonymously, onAuthStateChanged } = window.firebaseModules;
                    
                    this.app = initializeApp(this.config);
                    this.db = getFirestore(this.app);
                    this.auth = getAuth(this.app);

                    await signInAnonymously(this.auth);
                    
                    return new Promise((resolve, reject) => {
                        onAuthStateChanged(this.auth, (user) => {
                            if (user) {
                                this.userId = user.uid;
                                resolve(true);
                            } else {
                                reject(new Error("Authentication failed"));
                            }
                        });
                    });
                } catch (error) {
                    console.error("Firebase initialization error:", error);
                    throw error;
                }
            }

            async getAllSuites() {
                return [];
            }

            async saveSuite(suite) {
                const { collection, addDoc } = window.firebaseModules;
                suite.userId = this.userId;
                suite.last_run_time = suite.last_run_time || null;
                suite.last_run_status = suite.last_run_status || 'NEVER_RUN';
                suite.last_run_log = suite.last_run_log || '';
                
                const docRef = await addDoc(collection(this.db, 'test_suites'), suite);
                return docRef.id;
            }

            async updateSuite(id, updates) {
                const { doc, updateDoc } = window.firebaseModules;
                const docRef = doc(this.db, 'test_suites', id);
                await updateDoc(docRef, updates);
            }

            async deleteSuite(id) {
                const { doc, deleteDoc } = window.firebaseModules;
                const docRef = doc(this.db, 'test_suites', id);
                await deleteDoc(docRef);
            }

            async subscribeToChanges(callback) {
                const { collection, query, where, onSnapshot } = window.firebaseModules;
                const q = query(
                    collection(this.db, 'test_suites'),
                    where('userId', '==', this.userId)
                );
                
                this.unsubscribe = onSnapshot(q, (snapshot) => {
                    const suites = [];
                    snapshot.forEach((doc) => {
                        suites.push({ id: doc.id, ...doc.data() });
                    });
                    callback(suites);
                });
            }

            getStatusMessage() {
                return `Connected: Firebase (User: ${this.userId ? this.userId.substring(0, 8) + '...' : 'Unknown'})`;
            }
        }

        // ============================================
        // CUSTOM API BACKEND
        // ============================================
        
        class CustomApiBackend extends StorageBackend {
            constructor(config) {
                super();
                this.baseUrl = config.baseUrl;
                this.authHeader = config.authHeader;
                this.pollInterval = null;
            }

            async initialize() {
                try {
                    await this._fetch('GET', '');
                    return true;
                } catch (error) {
                    throw new Error(`Cannot connect to API: ${error.message}`);
                }
            }

            async getAllSuites() {
                const response = await this._fetch('GET', '');
                return response;
            }

            async saveSuite(suite) {
                suite.last_run_time = suite.last_run_time || null;
                suite.last_run_status = suite.last_run_status || 'NEVER_RUN';
                suite.last_run_log = suite.last_run_log || '';
                
                const response = await this._fetch('POST', '', suite);
                return response.id;
            }

            async updateSuite(id, updates) {
                await this._fetch('PUT', `/${id}`, updates);
            }

            async deleteSuite(id) {
                await this._fetch('DELETE', `/${id}`);
            }

            async subscribeToChanges(callback) {
                const poll = async () => {
                    try {
                        const suites = await this.getAllSuites();
                        callback(suites);
                    } catch (error) {
                        console.error("Polling error:", error);
                    }
                };
                
                await poll();
                this.pollInterval = setInterval(poll, 5000);
            }

            async _fetch(method, path, body = null) {
                const options = {
                    method,
                    headers: {
                        'Content-Type': 'application/json'
                    }
                };

                if (this.authHeader) {
                    options.headers['Authorization'] = this.authHeader;
                }

                if (body) {
                    options.body = JSON.stringify(body);
                }

                const response = await fetch(this.baseUrl + path, options);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                if (method !== 'DELETE') {
                    return await response.json();
                }
            }

            getStatusMessage() {
                return `Connected: Custom API (${this.baseUrl})`;
            }
        }

        // ============================================
        // STORAGE MANAGER
        // ============================================
        
        async function initializeStorage() {
            try {
                const savedConfig = localStorage.getItem('storage_config');
                if (savedConfig) {
                    storageConfig = JSON.parse(savedConfig);
                } else {
                    storageConfig = { type: 'localStorage' };
                    localStorage.setItem('storage_config', JSON.stringify(storageConfig));
                }

                await connectToStorage(storageConfig);
                
            } catch (error) {
                console.error("Storage initialization error:", error);
                showMessage("Failed to initialize storage: " + error.message, 'error');
                document.getElementById('storage-info').textContent = "Storage initialization failed. Click Settings to configure.";
            }
        }

        async function connectToStorage(config) {
            try {
                switch (config.type) {
                    case 'localStorage':
                        currentStorage = new LocalStorageBackend();
                        break;
                    
                    case 'firebase':
                        if (!config.firebaseConfig) {
                            throw new Error("Firebase configuration is missing");
                        }
                        currentStorage = new FirebaseBackend(config.firebaseConfig);
                        break;
                    
                    case 'customApi':
                        if (!config.apiConfig) {
                            throw new Error("API configuration is missing");
                        }
                        currentStorage = new CustomApiBackend(config.apiConfig);
                        break;
                    
                    default:
                        throw new Error("Unknown storage type: " + config.type);
                }

                document.getElementById('storage-info').textContent = "Connecting to storage...";
                await currentStorage.initialize();
                await currentStorage.subscribeToChanges(renderTestSuites);
                document.getElementById('storage-info').textContent = currentStorage.getStatusMessage();
                showMessage("Storage connected successfully", 'success');
                
            } catch (error) {
                console.error("Storage connection error:", error);
                currentStorage = null;
                throw error;
            }
        }

        // ============================================
        // SETTINGS MODAL
        // ============================================
        
        function openSettingsModal() {
            if (storageConfig) {
                document.querySelector(`input[name="storage-type"][value="${storageConfig.type}"]`).checked = true;
                
                if (storageConfig.type === 'firebase' && storageConfig.firebaseConfig) {
                    const fc = storageConfig.firebaseConfig;
                    document.getElementById('firebase-api-key').value = fc.apiKey || '';
                    document.getElementById('firebase-auth-domain').value = fc.authDomain || '';
                    document.getElementById('firebase-project-id').value = fc.projectId || '';
                    document.getElementById('firebase-storage-bucket').value = fc.storageBucket || '';
                    document.getElementById('firebase-messaging-sender-id').value = fc.messagingSenderId || '';
                    document.getElementById('firebase-app-id').value = fc.appId || '';
                }
                
                if (storageConfig.type === 'customApi' && storageConfig.apiConfig) {
                    document.getElementById('custom-api-url').value = storageConfig.apiConfig.baseUrl || '';
                    document.getElementById('custom-api-auth').value = storageConfig.apiConfig.authHeader || '';
                }
            }
            
            document.querySelectorAll('input[name="storage-type"]').forEach(radio => {
                radio.addEventListener('change', () => {
                    document.getElementById('firebase-config').classList.toggle('hidden', radio.value !== 'firebase');
                    document.getElementById('custom-api-config').classList.toggle('hidden', radio.value !== 'customApi');
                });
            });
            
            const selectedType = document.querySelector('input[name="storage-type"]:checked').value;
            document.getElementById('firebase-config').classList.toggle('hidden', selectedType !== 'firebase');
            document.getElementById('custom-api-config').classList.toggle('hidden', selectedType !== 'customApi');
            
            document.getElementById('settings-modal').classList.remove('hidden');
        }

        function closeSettingsModal() {
            document.getElementById('settings-modal').classList.add('hidden');
        }

        async function saveStorageSettings() {
            const selectedType = document.querySelector('input[name="storage-type"]:checked').value;
            
            const newConfig = { type: selectedType };
            
            if (selectedType === 'firebase') {
                newConfig.firebaseConfig = {
                    apiKey: document.getElementById('firebase-api-key').value,
                    authDomain: document.getElementById('firebase-auth-domain').value,
                    projectId: document.getElementById('firebase-project-id').value,
                    storageBucket: document.getElementById('firebase-storage-bucket').value,
                    messagingSenderId: document.getElementById('firebase-messaging-sender-id').value,
                    appId: document.getElementById('firebase-app-id').value
                };
                
                if (!newConfig.firebaseConfig.apiKey || !newConfig.firebaseConfig.projectId) {
                    showMessage("Please fill in all required Firebase fields", 'error');
                    return;
                }
            }
            
            if (selectedType === 'customApi') {
                newConfig.apiConfig = {
                    baseUrl: document.getElementById('custom-api-url').value,
                    authHeader: document.getElementById('custom-api-auth').value
                };
                
                if (!newConfig.apiConfig.baseUrl) {
                    showMessage("Please enter the API base URL", 'error');
                    return;
                }
            }
            
            localStorage.setItem('storage_config', JSON.stringify(newConfig));
            storageConfig = newConfig;
            closeSettingsModal();
            document.getElementById('storage-info').textContent = "Reconnecting to storage...";
            
            try {
                await connectToStorage(newConfig);
            } catch (error) {
                showMessage("Failed to connect: " + error.message, 'error');
                document.getElementById('storage-info').textContent = "Connection failed. Click Settings to reconfigure.";
            }
        }

        // ============================================
        // TEST SUITE MANAGEMENT
        // ============================================
        
        let testSuites = [];
        let editingSuiteId = null;

        function renderTestSuites(suites) {
            testSuites = suites;
            const container = document.getElementById('test-suites');
            const loadingMessage = document.getElementById('loading-message');
            
            if (loadingMessage) {
                loadingMessage.remove();
            }
            
            if (suites.length === 0) {
                container.innerHTML = '<p class="text-gray-500">No test suites configured. Click "Add New Test Suite" to create one.</p>';
                return;
            }
            
            container.innerHTML = suites.map(suite => {
                const statusColor = suite.last_run_status === 'SUCCESS' ? 'text-green-400' :
                                   suite.last_run_status === 'FAILURE' ? 'text-red-400' : 'text-gray-500';
                
                const execModeIndicator = suite.execution_mode === 'simulated' ? 
                    '<span class="text-xs text-yellow-400 ml-2">[Simulated]</span>' : 
                    '<span class="text-xs text-green-400 ml-2">[Real Execution]</span>';
                
                return `
                    <div class="bg-gray-800 p-5 rounded-lg shadow-lg border border-gray-700">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h3 class="text-xl font-bold text-white">${escapeHtml(suite.name)}${execModeIndicator}</h3>
                                <p class="text-sm text-gray-400">${escapeHtml(suite.description || 'No description')}</p>
                            </div>
                            <span class="px-3 py-1 text-xs font-semibold rounded-full bg-gray-700 text-gray-300">
                                ${escapeHtml(suite.language)}
                            </span>
                        </div>
                        
                        ${suite.parameters && suite.parameters.length > 0 ? `
                            <div class="mb-3 text-sm">
                                <span class="text-gray-400">Parameters:</span>
                                ${suite.parameters.map(p => `<span class="ml-2 text-emerald-400">${escapeHtml(p.key)}=${escapeHtml(p.value)}</span>`).join(', ')}
                            </div>
                        ` : ''}
                        
                        ${suite.inputFiles && suite.inputFiles.length > 0 ? `
                            <div class="mb-3 text-sm">
                                <span class="text-gray-400">Input Files:</span>
                                ${suite.inputFiles.map(f => `<span class="ml-2 text-blue-400">${escapeHtml(f.filename)}</span>`).join(', ')}
                            </div>
                        ` : ''}
                        
                        <div class="flex items-center justify-between">
                            <div class="text-sm ${statusColor}">
                                <strong>Last Run:</strong> ${suite.last_run_status}
                                ${suite.last_run_time ? `<span class="text-gray-500 ml-2">${new Date(suite.last_run_time).toLocaleString()}</span>` : ''}
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="runTestSuite('${suite.id}')" 
                                    class="bg-emerald-600 hover:bg-emerald-500 text-white text-sm font-semibold py-1 px-3 rounded transition">
                                    ▶ Run
                                </button>
                                <button onclick="editSuite('${suite.id}')" 
                                    class="bg-blue-600 hover:bg-blue-500 text-white text-sm font-semibold py-1 px-3 rounded transition">
                                    Edit
                                </button>
                                <button onclick="deleteSuite('${suite.id}')" 
                                    class="bg-red-600 hover:bg-red-500 text-white text-sm font-semibold py-1 px-3 rounded transition">
                                    Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function openAddSuiteModal() {
            if (!currentStorage) {
                showMessage("Please configure storage first (click Settings)", 'error');
                return;
            }
            
            editingSuiteId = null;
            document.getElementById('modal-title').textContent = 'Add New Test Suite';
            document.getElementById('suite-form').reset();
            document.getElementById('suite-id').value = '';
            document.getElementById('parameters-container').innerHTML = '';
            document.getElementById('input-files-container').innerHTML = '';
            document.getElementById('editor-modal').classList.remove('hidden');
        }

        function closeEditorModal() {
            document.getElementById('editor-modal').classList.add('hidden');
        }

        function editSuite(suiteId) {
            editingSuiteId = suiteId;
            const suite = testSuites.find(s => s.id === suiteId);
            if (!suite) return;
            
            document.getElementById('modal-title').textContent = 'Edit Test Suite';
            document.getElementById('suite-id').value = suiteId;
            document.getElementById('name').value = suite.name;
            document.getElementById('description').value = suite.description || '';
            document.getElementById('language').value = suite.language;
            document.getElementById('code').value = suite.code || '';
            document.getElementById('webhook_url').value = suite.webhook_url || '';
            document.getElementById('integration_info').value = suite.integration_info || '';
            
            const paramsContainer = document.getElementById('parameters-container');
            paramsContainer.innerHTML = '';
            if (suite.parameters && suite.parameters.length > 0) {
                suite.parameters.forEach(param => {
                    addParameterInput(param.key, param.value);
                });
            }
            
            const filesContainer = document.getElementById('input-files-container');
            filesContainer.innerHTML = '';
            if (suite.inputFiles && suite.inputFiles.length > 0) {
                suite.inputFiles.forEach(file => {
                    addInputFile(file.filename, file.content);
                });
            }
            
            document.getElementById('editor-modal').classList.remove('hidden');
        }

        async function handleSave(event) {
            event.preventDefault();
            
            if (!currentStorage) {
                showMessage("Storage not initialized", 'error');
                return;
            }
            
            const suite = {
                name: document.getElementById('name').value,
                description: document.getElementById('description').value,
                language: document.getElementById('language').value,
                code: document.getElementById('code').value,
                webhook_url: document.getElementById('webhook_url').value,
                integration_info: document.getElementById('integration_info').value,
                parameters: getParametersFromForm(),
                inputFiles: getInputFilesFromForm(),
                execution_mode: executionConfig.mode // Store which mode was active when saved
            };
            
            try {
                if (editingSuiteId) {
                    await currentStorage.updateSuite(editingSuiteId, suite);
                    showMessage("Test suite updated successfully", 'success');
                } else {
                    await currentStorage.saveSuite(suite);
                    showMessage("Test suite created successfully", 'success');
                }
                closeEditorModal();
            } catch (error) {
                console.error("Save error:", error);
                showMessage("Failed to save: " + error.message, 'error');
            }
        }

        async function deleteSuite(suiteId) {
            if (!confirm('Are you sure you want to delete this test suite?')) {
                return;
            }
            
            try {
                await currentStorage.deleteSuite(suiteId);
                showMessage("Test suite deleted", 'success');
            } catch (error) {
                console.error("Delete error:", error);
                showMessage("Failed to delete: " + error.message, 'error');
            }
        }

        // ============================================
        // PARAMETERS & INPUT FILES
        // ============================================
        
        function addParameterInput(key = '', value = '') {
            const container = document.getElementById('parameters-container');
            const id = 'param-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            
            const div = document.createElement('div');
            div.className = 'flex space-x-2';
            div.id = id;
            div.innerHTML = `
                <input type="text" placeholder="Key" value="${escapeHtml(key)}" 
                    class="flex-1 bg-gray-700 border border-gray-600 text-white p-2 rounded text-sm">
                <input type="text" placeholder="Value" value="${escapeHtml(value)}" 
                    class="flex-1 bg-gray-700 border border-gray-600 text-white p-2 rounded text-sm">
                <button type="button" onclick="document.getElementById('${id}').remove()" 
                    class="bg-red-600 hover:bg-red-500 text-white px-3 rounded text-sm">×</button>
            `;
            container.appendChild(div);
        }

        function getParametersFromForm() {
            const container = document.getElementById('parameters-container');
            const params = [];
            container.querySelectorAll('div').forEach(div => {
                const inputs = div.querySelectorAll('input[type="text"]');
                if (inputs.length === 2 && inputs[0].value && inputs[1].value) {
                    params.push({
                        key: inputs[0].value,
                        value: inputs[1].value
                    });
                }
            });
            return params;
        }

        function addInputFile(filename = '', content = '') {
            const container = document.getElementById('input-files-container');
            const id = 'file-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            const fileInputId = 'file-input-' + id;
            
            const div = document.createElement('div');
            div.className = 'p-3 bg-gray-700 rounded border border-gray-600';
            div.id = id;
            div.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <input type="text" id="${id}-filename" placeholder="Filename (e.g., test_data.csv)" value="${escapeHtml(filename)}" 
                        class="flex-1 bg-gray-800 border border-gray-600 text-white p-2 rounded text-sm mr-2">
                    <label for="${fileInputId}" 
                        class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1 rounded text-sm cursor-pointer whitespace-nowrap mr-2">
                        Browse...
                    </label>
                    <input type="file" id="${fileInputId}" class="hidden">
                    <button type="button" onclick="document.getElementById('${id}').remove()" 
                        class="bg-red-600 hover:bg-red-500 text-white px-3 py-1 rounded text-sm">Remove</button>
                </div>
                <textarea id="${id}-content" placeholder="File content (or click Browse to load a file)..." rows="3" 
                    class="w-full bg-gray-800 border border-gray-600 text-white p-2 rounded text-sm font-mono">${escapeHtml(content)}</textarea>
                <div id="${id}-file-info" class="text-xs text-gray-400 mt-1"></div>
            `;
            container.appendChild(div);
            
            const fileInput = document.getElementById(fileInputId);
            fileInput.addEventListener('change', function(e) {
                handleFileLoad(e, id);
            });
        }
        
        function handleFileLoad(event, containerId) {
            const file = event.target.files[0];
            if (!file) return;
            
            const filenameInput = document.getElementById(`${containerId}-filename`);
            const contentTextarea = document.getElementById(`${containerId}-content`);
            const fileInfo = document.getElementById(`${containerId}-file-info`);
            
            filenameInput.value = file.name;
            fileInfo.textContent = `Loading ${file.name}...`;
            
            const reader = new FileReader();
            
            const isBinary = file.type.startsWith('image/') || 
                            file.type.startsWith('video/') || 
                            file.type.startsWith('audio/') ||
                            file.name.match(/\.(exe|bin|zip|tar|gz|pdf|doc|docx|xls|xlsx)$/i);
            
            reader.onload = function(e) {
                if (isBinary) {
                    const base64 = btoa(
                        new Uint8Array(e.target.result)
                            .reduce((data, byte) => data + String.fromCharCode(byte), '')
                    );
                    contentTextarea.value = `[Binary file - Base64 encoded]\n${base64}`;
                    fileInfo.innerHTML = `Loaded: <strong>${file.name}</strong> (${formatFileSize(file.size)}) - Binary file encoded as Base64`;
                } else {
                    contentTextarea.value = e.target.result;
                    fileInfo.innerHTML = `Loaded: <strong>${file.name}</strong> (${formatFileSize(file.size)})`;
                }
            };
            
            reader.onerror = function() {
                fileInfo.innerHTML = `Error loading file: ${file.name}`;
                contentTextarea.value = '';
            };
            
            if (isBinary) {
                reader.readAsArrayBuffer(file);
            } else {
                reader.readAsText(file);
            }
            
            event.target.value = '';
        }
        
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
        }

        function getInputFilesFromForm() {
            const container = document.getElementById('input-files-container');
            const files = [];
            container.querySelectorAll('div[id^="file-"]').forEach(div => {
                const id = div.id;
                const filenameInput = document.getElementById(`${id}-filename`);
                const contentTextarea = document.getElementById(`${id}-content`);
                
                if (filenameInput && contentTextarea) {
                    const filename = filenameInput.value;
                    const content = contentTextarea.value;
                    
                    if (filename && content) {
                        files.push({ filename, content });
                    }
                }
            });
            return files;
        }

        // ============================================
        // RUN TEST SUITE (WITH REAL EXECUTION)
        // ============================================
        
        async function runTestSuite(suiteId) {
            const suite = testSuites.find(s => s.id === suiteId);
            if (!suite) return;
            
            // Open modal immediately
            document.getElementById('run-modal-title').textContent = `Run Test Suite: ${suite.name}`;
            document.getElementById('run-modal-content').innerHTML = '<div class="text-center"><div class="spinner mx-auto mb-2"></div><div>Initializing execution...</div></div>';
            document.getElementById('run-status-indicator').innerHTML = '<div class="spinner mr-2"></div>Running...';
            document.getElementById('run-modal').classList.remove('hidden');
            
            const startTime = new Date();
            let log = `--- STARTING PIPELINE: ${suite.name} ---\n`;
            log += `[${formatTime(startTime)}] Language: ${suite.language}\n`;
            log += `[${formatTime(startTime)}] Description: ${suite.description || '(none)'}\n`;
            log += `[${formatTime(startTime)}] Execution Mode: ${executionConfig.mode === 'real' ? 'REAL EXECUTION' : 'SIMULATED'}\n\n`;
            
            log += `--- Execution Parameters ---\n`;
            if (suite.parameters && suite.parameters.length > 0) {
                suite.parameters.forEach(p => {
                    log += `  - ${p.key}: ${p.value}\n`;
                });
            } else {
                log += `  (no parameters)\n`;
            }
            log += `\n`;
            
            if (suite.inputFiles && suite.inputFiles.length > 0) {
                log += `--- Input Files ---\n`;
                suite.inputFiles.forEach(f => {
                    log += `  - ${f.filename} (${f.content.length} bytes)\n`;
                });
                log += `\n`;
            }
            
            document.getElementById('run-modal-content').textContent = log;
            
            let status = 'SUCCESS';
            let executionOutput = '';
            
            if (executionConfig.mode === 'real' && suite.code) {
                log += `[EXECUTION] Running ${suite.language} code...\n\n`;
                document.getElementById('run-modal-content').textContent = log;
                
                try {
                    let result;
                    
                    if (suite.language === 'Python') {
                        log += `[PYTHON] Initializing Pyodide...\n`;
                        document.getElementById('run-modal-content').textContent = log;
                        
                        result = await executePythonCode(suite.code, suite.inputFiles || []);
                        
                    } else if (suite.language === 'Java') {
                        log += `[JAVA] Executing via ${executionConfig.javaType === 'jdoodle' ? 'JDoodle API' : 'local compiler'}...\n`;
                        document.getElementById('run-modal-content').textContent = log;
                        
                        result = await executeJavaCode(suite.code, suite.inputFiles || []);
                        
                    } else if (suite.language === 'CSharp') {
                        log += `[C#] Executing via ${executionConfig.csharpType === 'jdoodle' ? 'JDoodle API' : 'local compiler'}...\n`;
                        document.getElementById('run-modal-content').textContent = log;
                        
                        result = await executeCSharpCode(suite.code, suite.inputFiles || []);
                        
                    } else {
                        result = {
                            success: false,
                            output: '',
                            error: `Language '${suite.language}' execution not yet implemented`
                        };
                    }
                    
                    if (result.success) {
                        log += `\n--- EXECUTION OUTPUT ---\n`;
                        log += result.output || '(no output)';
                        log += `\n--- END OUTPUT ---\n\n`;
                        executionOutput = result.output;
                        
                        // Check for error indicators in output even if execution succeeded
                        const errorIndicators = [
                            'Error:', 'ERROR:', 
                            'Exception:', 'Traceback',
                            'Failed:', 'FAILED', 'failed',
                            'not found', 'cannot find',
                            'invalid', 'Invalid'
                        ];
                        
                        const hasErrorInOutput = errorIndicators.some(indicator => 
                            (result.output || '').includes(indicator)
                        );
                        
                        if (hasErrorInOutput) {
                            status = 'FAILURE';
                            log += `[WARNING] Error indicators detected in output despite successful execution.\n`;
                        }
                    } else {
                        log += `\n--- EXECUTION ERROR ---\n`;
                        log += result.error || 'Unknown error';
                        log += `\n--- END ERROR ---\n\n`;
                        status = 'FAILURE';
                        executionOutput = result.error;
                    }
                    
                } catch (error) {
                    log += `\n[ERROR] Execution failed: ${error.message}\n`;
                    status = 'FAILURE';
                    executionOutput = error.message;
                }
                
            } else {
                // Simulated mode
                log += `[CODE] Displaying code (simulation mode)...\n\n`;
                if (suite.code) {
                    log += suite.code.split('\n').map(line => `  ${line}`).join('\n');
                } else {
                    log += `  (no code defined)`;
                }
                log += `\n\n[RESULT] Simulated execution completed.\n`;
            }
            
            const endTime = new Date();
            const duration = ((endTime - startTime) / 1000).toFixed(2);
            
            log += `\n[STATUS] ${status}: ${status === 'SUCCESS' ? 'All tests passed.' : 'Execution encountered errors.'}\n\n`;
            log += `--- PIPELINE ENDED ---\n`;
            log += `Duration: ${duration}s. Final Status: ${status}`;
            
            document.getElementById('run-modal-content').textContent = log;
            document.getElementById('run-status-indicator').innerHTML = status === 'SUCCESS' ? 
                '<span class="text-green-400">Completed</span>' : 
                '<span class="text-red-400">Failed</span>';
            
            // Update suite with run information
            try {
                await currentStorage.updateSuite(suiteId, {
                    last_run_status: status,
                    last_run_time: new Date().toISOString(),
                    last_run_log: log
                });
            } catch (error) {
                console.error("Update error:", error);
                showMessage("Failed to update run status: " + error.message, 'error');
            }
        }

        function closeRunModal() {
            document.getElementById('run-modal').classList.add('hidden');
        }

        function formatTime(date) {
            return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }

        // ============================================
        // IMPORT/EXPORT
        // ============================================
        
        function exportToJSON() {
            const data = {
                exported_at: new Date().toISOString(),
                storage_type: storageConfig.type,
                execution_mode: executionConfig.mode,
                test_suites: testSuites
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pipeline_suites_export_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showMessage("Export completed", 'success');
        }

        function importFromJSON(event) {
            if (!currentStorage) {
                showMessage("Please configure storage first", 'error');
                event.target.value = null;
                return;
            }
            
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const content = JSON.parse(e.target.result);
                    let suitesToImport = [];
                    
                    if (content.test_suites && Array.isArray(content.test_suites)) {
                        suitesToImport = content.test_suites;
                    } else if (Array.isArray(content)) {
                        suitesToImport = content;
                    } else {
                        showMessage("Invalid JSON format", 'error');
                        return;
                    }
                    
                    if (suitesToImport.length === 0) {
                        showMessage("No test suites found in file", 'info');
                        return;
                    }
                    
                    let importCount = 0;
                    for (const suite of suitesToImport) {
                        try {
                            const { id, ...newSuite } = suite;
                            if (!newSuite.inputFiles) newSuite.inputFiles = [];
                            if (!newSuite.parameters) newSuite.parameters = [];
                            await currentStorage.saveSuite(newSuite);
                            importCount++;
                        } catch (error) {
                            console.error("Failed to import suite:", error);
                        }
                    }
                    
                    showMessage(`Imported ${importCount} test suite(s)`, 'success');
                    
                } catch (error) {
                    console.error("Import error:", error);
                    showMessage("Failed to import: " + error.message, 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = null;
        }

        // ============================================
        // UTILITIES
        // ============================================
        
        function showMessage(text, type = 'info') {
            const messageBox = document.getElementById('message-box');
            const colors = {
                success: 'bg-green-600',
                error: 'bg-red-600',
                info: 'bg-blue-600'
            };
            
            messageBox.className = `fixed top-5 right-5 z-50 transition-all duration-300 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg`;
            messageBox.textContent = text;
            messageBox.style.transform = 'translateX(0)';
            
            setTimeout(() => {
                messageBox.style.transform = 'translateX(150%)';
            }, 3000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        
        window.onload = async function() {
            loadExecutionConfig();
            await initializeStorage();
        };
    </script>
</body>
</html>