<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Karokh's CI/CD Test Pipeline Manager - With Real Execution</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <!-- Load Pyodide for Python and Robot Framework execution -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
        }
        .code-area {
            font-family: 'Consolas', 'Monaco', monospace;
            min-height: 200px;
        }
        .modal-open {
            overflow: hidden;
        }
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid white;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 p-4 sm:p-8">

    <div id="app" class="max-w-6xl mx-auto">
        <header class="mb-8 flex flex-col sm:flex-row justify-between items-center pb-4 border-b border-gray-700">
            <h1 class="text-4xl font-extrabold text-emerald-400 mb-4 sm:mb-0">Karokh's Pipeline Test Manager</h1>
            <div class="flex space-x-3 flex-wrap gap-2">
                <button onclick="openExecutionSettingsModal()"
                    class="bg-orange-600 hover:bg-orange-500 text-white font-semibold py-2 px-4 rounded-lg shadow-lg transition duration-200">
                    Execution Settings
                </button>
                <button onclick="openSettingsModal()"
                    class="bg-purple-600 hover:bg-purple-500 text-white font-semibold py-2 px-4 rounded-lg shadow-lg transition duration-200">
                    Storage Settings
                </button>
                <button onclick="openAddSuiteModal()"
                    class="bg-emerald-600 hover:bg-emerald-500 text-white font-semibold py-2 px-4 rounded-lg shadow-lg transition duration-200">
                    + Add New Test Suite
                </button>
                
                <label for="import-file-input" class="bg-sky-600 hover:bg-sky-500 text-white font-semibold py-2 px-4 rounded-lg shadow-lg transition duration-200 cursor-pointer flex items-center">
                    Import JSON
                </label>
                <input type="file" id="import-file-input" class="hidden" accept=".json" onchange="importFromJSON(event)">
                
                <button onclick="exportToJSON()"
                    class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg shadow-lg transition duration-200">
                    Export JSON
                </button>
            </div>
        </header>

        <div id="storage-status" class="text-sm mb-4 p-3 bg-gray-800 rounded-lg shadow-inner">
            <p id="storage-info">Initializing storage...</p>
        </div>

        <div id="execution-status" class="text-sm mb-4 p-3 bg-gray-800 rounded-lg shadow-inner border-l-4 border-orange-500">
            <p id="execution-info">Execution Mode: <span id="exec-mode-display" class="font-semibold">Loading...</span></p>
        </div>

        <main id="suite-list-container">
            <h2 class="text-2xl font-bold mb-4 text-gray-300">Configured Test Suites</h2>
            <div id="test-suites" class="space-y-6">
                <!-- Test suite cards will be rendered here -->
                <p id="loading-message" class="text-gray-500">Loading test suites...</p>
            </div>
        </main>

        <!-- Notification/Message Box -->
        <div id="message-box" class="fixed top-5 right-5 z-50 transition-all duration-300 transform translate-x-full">
        </div>

    </div>

    <!-- Execution Settings Modal -->
    <div id="execution-settings-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70">
        <div class="bg-gray-800 p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto">
            <h3 class="text-3xl font-bold mb-6 text-orange-400">Execution Configuration</h3>
            
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-300 mb-3">Execution Mode</label>
                <div class="space-y-3">
                    <label class="flex items-start p-4 bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-650">
                        <input type="radio" name="execution-mode" value="real" checked class="mt-1 mr-3">
                        <div>
                            <div class="font-semibold text-green-400">Real Execution (Recommended)</div>
                            <div class="text-sm text-gray-400">Actually run your code and see real output. Python & Robot Framework run in browser, Java/C# require API or local compiler.</div>
                        </div>
                    </label>
                    
                    <label class="flex items-start p-4 bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-650">
                        <input type="radio" name="execution-mode" value="simulated" class="mt-1 mr-3">
                        <div>
                            <div class="font-semibold text-yellow-400">Simulated Execution</div>
                            <div class="text-sm text-gray-400">Display code without running it. Useful for planning and documentation.</div>
                        </div>
                    </label>
                </div>
            </div>

            <!-- Python Execution Config -->
            <div id="python-exec-config" class="mb-6 p-4 bg-gray-900 rounded-lg border border-gray-700">
                <h4 class="font-semibold text-blue-400 mb-3">üêç Python Execution</h4>
                <div class="text-sm text-gray-400 mb-2">
                    <span class="text-green-400">‚úì Browser-based execution via Pyodide (WebAssembly)</span>
                </div>
                <div class="text-xs text-gray-500">
                    Python code runs directly in your browser. No server needed. First run may take a few seconds to initialize.
                </div>
            </div>

            
            <!-- Robot Framework Execution Config -->
            <div id="robot-exec-config" class="mb-6 p-4 bg-gray-900 rounded-lg border border-teal-700">
                <h4 class="font-semibold text-teal-400 mb-3">ü§ñ Robot Framework Execution</h4>
                <p class="text-xs text-gray-400 mb-3">Choose how to execute Robot Framework tests:</p>
                
                <div class="space-y-2 mb-3">
                    <label class="flex items-center">
                        <input type="radio" name="robot-execution-type" value="browser" checked class="mr-2">
                        <span class="text-sm">‚ú® Browser-based (via Pyodide) - No setup required!</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="robot-execution-type" value="backend" class="mr-2">
                        <span class="text-sm">Local Backend Server (for SeleniumLibrary/browser automation)</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="robot-execution-type" value="api" class="mr-2">
                        <span class="text-sm">Remote API (Limited - basic tests only)</span>
                    </label>
                </div>

                <div id="robot-browser-config" class="mb-3">
                    <div class="text-xs text-green-300 bg-gray-800 p-2 rounded mb-2">
                        ‚úì <strong>Browser-based execution (Recommended)</strong><br>
                        ‚Ä¢ Runs directly in your browser via WebAssembly<br>
                        ‚Ä¢ Auto-installs Robot Framework on first run (~10-15 seconds)<br>
                        ‚Ä¢ <strong>NEW: Includes BrowserLibrary for DOM automation!</strong><br>
                        ‚Ä¢ Perfect for API tests, data validation, business logic<br>
                        ‚Ä¢ Test forms, click buttons, verify page content<br>
                        ‚Ä¢ No server, no API keys, no installation required!
                    </div>
                    <div class="text-xs text-blue-300 bg-gray-800 p-2 rounded mb-2">
                        <strong>üìö BrowserLibrary Keywords Available:</strong><br>
                        ‚Ä¢ Click Element | Input Text | Get Text | Get Value<br>
                        ‚Ä¢ Element Should Be Visible | Element Should Contain<br>
                        ‚Ä¢ Page Should Contain | Element Should Exist<br>
                        ‚Ä¢ Check Checkbox | Uncheck Checkbox<br>
                        ‚Ä¢ Select From List | Execute JavaScript<br>
                        ‚Ä¢ Wait For Element | Get Element Count
                    </div>
                    <div class="text-xs text-yellow-300 bg-gray-800 p-2 rounded">
                        <strong>Limitation:</strong> Same-origin policy applies (can only test current page/domain).
                        Use backend server option for cross-origin testing with SeleniumLibrary.
                    </div>
                </div>

                <div id="robot-backend-config" class="hidden mb-3">
                    <div class="mb-2">
                        <label class="block text-xs text-gray-400 mb-1">Backend Server URL</label>
                        <input type="text" id="robot-backend-url" value="http://localhost:5000" 
                            class="w-full bg-gray-800 border border-gray-600 text-white p-2 rounded text-sm">
                    </div>
                    <div class="text-xs text-gray-500 bg-gray-800 p-2 rounded mb-2">
                        <strong class="text-teal-300">Quick Setup:</strong><br>
                        1. <code class="bg-gray-700 px-1">pip install robotframework robotframework-seleniumlibrary flask flask-cors</code><br>
                        2. Run robot_server.py (included in download)<br>
                        3. Install ChromeDriver or GeckoDriver for browser tests
                    </div>
                    <button type="button" onclick="window.open('https://robotframework.org/', '_blank')" 
                        class="text-xs text-teal-400 hover:underline">
                        ‚Üí Robot Framework Documentation
                    </button>
                </div>

                <div id="robot-api-config" class="hidden">
                    <div class="text-xs text-yellow-300 bg-gray-800 p-2 rounded mb-2">
                        ‚ö†Ô∏è API execution is limited. Use browser or local backend for full features.
                    </div>
                    <div class="mb-2">
                        <label class="block text-xs text-gray-400 mb-1">API Endpoint</label>
                        <input type="text" id="robot-api-url" placeholder="https://your-robot-api.com/execute" 
                            class="w-full bg-gray-800 border border-gray-600 text-white p-2 rounded text-sm">
                    </div>
                </div>
            </div>

            <!-- Java Execution Config -->
            <div id="java-exec-config" class="mb-6 p-4 bg-gray-900 rounded-lg border border-gray-700">
                <h4 class="font-semibold text-orange-400 mb-3">‚òï Java Execution</h4>
                <p class="text-xs text-gray-400 mb-3">Choose how to execute Java code:</p>
                
                <div class="space-y-2 mb-3">
                    <label class="flex items-center">
                        <input type="radio" name="java-execution-type" value="jdoodle" checked class="mr-2">
                        <span class="text-sm">JDoodle API (requires free API key from jdoodle.com)</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="java-execution-type" value="local" class="mr-2">
                        <span class="text-sm">Local compiler (requires Java installed + backend server)</span>
                    </label>
                </div>

                <div id="jdoodle-config">
                    <div class="mb-2">
                        <label class="block text-xs text-gray-400 mb-1">JDoodle Client ID</label>
                        <input type="text" id="jdoodle-client-id" placeholder="Get from jdoodle.com" 
                            class="w-full bg-gray-800 border border-gray-600 text-white p-2 rounded text-sm">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">JDoodle Client Secret</label>
                        <input type="text" id="jdoodle-client-secret" placeholder="Get from jdoodle.com" 
                            class="w-full bg-gray-800 border border-gray-600 text-white p-2 rounded text-sm">
                    </div>
                    <a href="https://www.jdoodle.com/compiler-api" target="_blank" 
                        class="text-xs text-blue-400 hover:underline mt-1 inline-block">
                        ‚Üí Get free API key (200 requests/day)
                    </a>
                </div>
            </div>

            <!-- C# Execution Config -->
            <div id="csharp-exec-config" class="mb-6 p-4 bg-gray-900 rounded-lg border border-gray-700">
                <h4 class="font-semibold text-purple-400 mb-3">#Ô∏è‚É£ C# Execution</h4>
                <p class="text-xs text-gray-400 mb-3">Choose how to execute C# code:</p>
                
                <div class="space-y-2 mb-3">
                    <label class="flex items-center">
                        <input type="radio" name="csharp-execution-type" value="jdoodle" checked class="mr-2">
                        <span class="text-sm">JDoodle API (same credentials as Java)</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="csharp-execution-type" value="local" class="mr-2">
                        <span class="text-sm">Local compiler (requires .NET/Mono + backend server)</span>
                    </label>
                </div>
            </div>

            <div class="flex justify-end space-x-3">
                <button type="button" onclick="closeExecutionSettingsModal()"
                    class="bg-gray-600 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                    Cancel
                </button>
                <button type="button" onclick="saveExecutionSettings()"
                    class="bg-orange-600 hover:bg-orange-500 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                    Save Settings
                </button>
            </div>
        </div>
    </div>

    <!-- Storage Settings Modal -->
    <div id="settings-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70">
        <div class="bg-gray-800 p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto">
            <h3 class="text-3xl font-bold mb-6 text-purple-400">Storage Configuration</h3>
            
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-300 mb-3">Storage Backend</label>
                <div class="space-y-3">
                    <label class="flex items-start p-4 bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-650">
                        <input type="radio" name="storage-type" value="localStorage" checked class="mt-1 mr-3">
                        <div>
                            <div class="font-semibold text-emerald-400">Local Storage (Browser)</div>
                            <div class="text-sm text-gray-400">Store data in your browser. Simple, no setup required. Data stays on this device only.</div>
                        </div>
                    </label>
                    
                    <label class="flex items-start p-4 bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-650">
                        <input type="radio" name="storage-type" value="firebase" class="mt-1 mr-3">
                        <div>
                            <div class="font-semibold text-orange-400">Firebase (Google Cloud)</div>
                            <div class="text-sm text-gray-400">Sync data across devices. Requires free Firebase account and credentials.</div>
                        </div>
                    </label>
                    
                    <label class="flex items-start p-4 bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-650">
                        <input type="radio" name="storage-type" value="customApi" class="mt-1 mr-3">
                        <div>
                            <div class="font-semibold text-blue-400">Custom API Backend</div>
                            <div class="text-sm text-gray-400">Connect to your own server/API. Full control over data storage.</div>
                        </div>
                    </label>
                </div>
            </div>

            <!-- Firebase Configuration -->
            <div id="firebase-config" class="hidden mb-6 p-4 bg-gray-900 rounded-lg border border-gray-700">
                <h4 class="font-semibold text-orange-400 mb-3">Firebase Configuration</h4>
                <p class="text-xs text-gray-400 mb-3">Get these values from your Firebase Console ‚Üí Project Settings ‚Üí General</p>
                
                <div class="space-y-3">
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">API Key</label>
                        <input type="text" id="firebase-api-key" placeholder="AIzaSy..." class="w-full bg-gray-800 border border-gray-600 text-white p-2 rounded text-sm">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">Auth Domain</label>
                        <input type="text" id="firebase-auth-domain" placeholder="your-app.firebaseapp.com" class="w-full bg-gray-800 border border-gray-600 text-white p-2 rounded text-sm">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">Project ID</label>
                        <input type="text" id="firebase-project-id" placeholder="your-project-id" class="w-full bg-gray-800 border border-gray-600 text-white p-2 rounded text-sm">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">Storage Bucket</label>
                        <input type="text" id="firebase-storage-bucket" placeholder="your-app.appspot.com" class="w-full bg-gray-800 border border-gray-600 text-white p-2 rounded text-sm">
                    </div>
                </div>
                <a href="https://firebase.google.com/docs/web/setup" target="_blank" 
                    class="text-xs text-blue-400 hover:underline mt-2 inline-block">
                    ‚Üí Firebase Setup Documentation
                </a>
            </div>

            <!-- Custom API Configuration -->
            <div id="custom-api-config" class="hidden mb-6 p-4 bg-gray-900 rounded-lg border border-gray-700">
                <h4 class="font-semibold text-blue-400 mb-3">Custom API Configuration</h4>
                <p class="text-xs text-gray-400 mb-3">Your API should support: GET (list), POST (create), PUT (update), DELETE operations</p>
                
                <div class="space-y-3">
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">Base URL</label>
                        <input type="text" id="api-base-url" placeholder="https://your-api.com/test-suites" class="w-full bg-gray-800 border border-gray-600 text-white p-2 rounded text-sm">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">Authorization Header (Optional)</label>
                        <input type="text" id="api-auth-header" placeholder="Bearer your-token-here" class="w-full bg-gray-800 border border-gray-600 text-white p-2 rounded text-sm">
                    </div>
                </div>
            </div>

            <div class="flex justify-end space-x-3">
                <button type="button" onclick="closeSettingsModal()"
                    class="bg-gray-600 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                    Cancel
                </button>
                <button type="button" onclick="saveSettings()"
                    class="bg-purple-600 hover:bg-purple-500 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                    Save & Connect
                </button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Suite Modal -->
    <div id="editor-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70">
        <div class="bg-gray-800 p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <h3 id="modal-title" class="text-3xl font-bold mb-6 text-emerald-400">Add New Test Suite</h3>
            
            <form id="suite-form" onsubmit="handleSave(event)">
                <input type="hidden" id="suite-id">
                
                <div class="mb-4">
                    <label for="name" class="block text-sm font-medium text-gray-300 mb-1">Suite Name</label>
                    <input type="text" id="name" required class="w-full bg-gray-700 border border-gray-600 text-white p-3 rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                </div>
                
                <div class="mb-4">
                    <label for="description" class="block text-sm font-medium text-gray-300 mb-1">Description</label>
                    <textarea id="description" rows="2" class="w-full bg-gray-700 border border-gray-600 text-white p-3 rounded-lg focus:ring-emerald-500 focus:border-emerald-500"></textarea>
                </div>
                
                <div class="mb-4">
                    <label for="language" class="block text-sm font-medium text-gray-300 mb-1">Programming Language / Framework</label>
                    <select id="language" required class="w-full bg-gray-700 border border-gray-600 text-white p-3 rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                        <option value="python">Python</option>
                        <option value="robot">Robot Framework</option>
                        <option value="java">Java</option>
                        <option value="csharp">C#</option>
                    </select>
                </div>

                <div class="mb-4 border-t border-gray-700 pt-4">
                    <label class="block text-sm font-medium text-gray-300 mb-1">Environment Parameters</label>
                    <p class="text-xs text-gray-500 mb-2">Key-value pairs that can be accessed by your test code.</p>
                    <div id="parameters-container" class="space-y-2 mb-2">
                        <!-- Dynamic parameter inputs go here -->
                    </div>
                    <button type="button" onclick="addParameterInput()"
                        class="text-sm bg-emerald-500 hover:bg-emerald-400 text-white py-1 px-3 rounded-lg transition duration-200">
                        + Add Parameter
                    </button>
                    <input type="hidden" id="parameters-json">
                </div>

                <div class="mb-4 border-t border-gray-700 pt-4">
                    <label class="block text-sm font-medium text-gray-300 mb-1">External Test Inputs (Mock Files)</label>
                    <p class="text-xs text-gray-500 mb-3">Load files from your computer or manually enter content. You can add multiple files.</p>
                    <div id="input-files-container" class="space-y-4">
                        <!-- Dynamic input file groups go here -->
                    </div>
                    <button type="button" onclick="addInputFile()"
                        class="mt-3 text-sm bg-emerald-500 hover:bg-emerald-400 text-white py-1 px-3 rounded-lg transition duration-200">
                        + Add Test Input
                    </button>
                </div>

                <div class="mb-4 border-t border-gray-700 pt-4">
                    <label for="code" class="block text-sm font-medium text-gray-300 mb-1">Internal Test Logic (Code)</label>
                    <p class="text-xs text-gray-500 mb-1">Your test script code (e.g., Python, Java, C# logic).</p>
                    <textarea id="code" rows="8" class="code-area w-full bg-gray-900 border border-gray-600 text-green-400 p-3 rounded-lg focus:ring-emerald-500 focus:border-emerald-500"></textarea>
                </div>

                <div class="mb-4 border-t border-gray-700 pt-4">
                    <label for="webhook_url" class="block text-sm font-medium text-gray-300 mb-1">External Integration / Webhook URL (Optional)</label>
                    <input type="url" id="webhook_url" placeholder="https://your-ci-server/trigger" class="w-full bg-gray-700 border border-gray-600 text-white p-3 rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                </div>

                <div class="mb-6">
                    <label for="integration_info" class="block text-sm font-medium text-gray-300 mb-1">API/Program Integration Details</label>
                    <p class="text-xs text-gray-500 mb-1">Describe external programs or API calls this test would make.</p>
                    <textarea id="integration_info" rows="3" class="w-full bg-gray-700 border border-gray-600 text-white p-3 rounded-lg focus:ring-emerald-500 focus:border-emerald-500"></textarea>
                </div>

                <div class="mb-6 border-t border-gray-700 pt-4">
                    <div class="flex items-center justify-between mb-3">
                        <label class="block text-sm font-medium text-gray-300">üìù Log File Configuration</label>
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="enable_log_saving" class="mr-2">
                            <span class="text-sm text-gray-400">Enable automatic log saving</span>
                        </label>
                    </div>
                    
                    <div id="log-config-options" class="space-y-3 hidden">
                        <div>
                            <label for="log_filename" class="block text-xs text-gray-400 mb-1">Log Filename Pattern</label>
                            <input type="text" id="log_filename" placeholder="test_log_{suite_name}_{timestamp}" 
                                value="log_{suite_name}_{timestamp}"
                                class="w-full bg-gray-700 border border-gray-600 text-white p-2 rounded-lg text-sm">
                            <p class="text-xs text-gray-500 mt-1">
                                Available variables: {suite_name}, {timestamp}, {date}, {time}, {status}
                            </p>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label for="log_format" class="block text-xs text-gray-400 mb-1">Log Format</label>
                                <select id="log_format" class="w-full bg-gray-700 border border-gray-600 text-white p-2 rounded-lg text-sm">
                                    <option value="txt">Plain Text (.txt)</option>
                                    <option value="json">JSON (.json)</option>
                                    <option value="html">HTML Report (.html)</option>
                                    <option value="xml">XML (.xml)</option>
                                    <option value="md">Markdown (.md)</option>
                                </select>
                            </div>
                            
                            <div>
                                <label for="log_save_trigger" class="block text-xs text-gray-400 mb-1">Save Trigger</label>
                                <select id="log_save_trigger" class="w-full bg-gray-700 border border-gray-600 text-white p-2 rounded-lg text-sm">
                                    <option value="always">After every run</option>
                                    <option value="failure">Only on failure</option>
                                    <option value="success">Only on success</option>
                                    <option value="manual">Manual only</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="text-xs bg-gray-800 p-2 rounded">
                            <span class="text-gray-400">üí° Tip:</span> Logs will download automatically based on your trigger setting. 
                            You can also manually download from the execution modal.
                        </div>
                    </div>
                </div>

                <script>
                    // Toggle log config options
                    document.getElementById('enable_log_saving').addEventListener('change', function(e) {
                        document.getElementById('log-config-options').classList.toggle('hidden', !e.target.checked);
                    });
                </script>

                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeEditorModal()"
                        class="bg-gray-600 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                        Cancel
                    </button>
                    <button type="submit"
                        class="bg-emerald-600 hover:bg-emerald-500 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                        Save Test Suite
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Run Modal -->
    <div id="run-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70"
         onclick="if (event.target.id === 'run-modal') closeRunModal()">
        <div class="bg-gray-800 p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto"
             onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h3 id="run-modal-title" class="text-2xl font-bold text-emerald-400">Run Test Suite</h3>
                <div id="run-status-indicator" class="text-sm"></div>
            </div>
            <div id="run-modal-content" class="bg-gray-900 p-4 rounded-lg text-sm font-mono text-green-400 whitespace-pre-wrap max-h-[600px] overflow-y-auto">
                <!-- Log output will be displayed here -->
            </div>
            <div class="mt-4 flex justify-end space-x-3">
                <button onclick="downloadCurrentLog()" id="download-log-btn"
                    class="bg-blue-600 hover:bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                    üíæ Download Log
                </button>
                <button onclick="closeRunModal()"
                    class="bg-gray-600 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK (loaded only when needed) -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        
        // Make Firebase functions available globally
        window.firebaseModules = {
            initializeApp,
            getFirestore,
            collection,
            addDoc,
            updateDoc,
            deleteDoc,
            doc,
            onSnapshot,
            query,
            where,
            getAuth,
            signInAnonymously,
            onAuthStateChanged
        };
    </script>

    <script>
        // ============================================
        // EXECUTION ENGINE
        // ============================================
        
        let pyodideInstance = null;
        let pyodideLoading = false;
        let robotFrameworkInstalled = false;
        let executionConfig = null;

        async function initializePyodide() {
            if (pyodideInstance) return pyodideInstance;
            if (pyodideLoading) {
                // Wait for existing load
                while (pyodideLoading) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                return pyodideInstance;
            }

            pyodideLoading = true;
            try {
                console.log("Loading Pyodide...");
                pyodideInstance = await loadPyodide({
                    indexURL: "https://cdn.jsdelivr.net/pyodide/v0.24.1/full/"
                });
                console.log("Pyodide loaded successfully");
                pyodideLoading = false;
                return pyodideInstance;
            } catch (error) {
                pyodideLoading = false;
                console.error("Failed to load Pyodide:", error);
                throw error;
            }
        }

        async function installRobotFramework() {
            if (robotFrameworkInstalled) return true;
            
            try {
                const pyodide = await initializePyodide();
                
                showMessage('Installing Robot Framework... This may take 10-15 seconds', 'info');
                
                // Install Robot Framework via micropip
                await pyodide.loadPackage('micropip');
                const micropip = pyodide.pyimport('micropip');
                await micropip.install('robotframework');
                
                // Create custom BrowserLibrary for DOM automation
                await pyodide.runPythonAsync(`
from robot.api.deco import keyword, library
import js
from js import document, window, console

@library(scope='GLOBAL')
class BrowserLibrary:
    """Custom Robot Framework library for browser automation using native DOM APIs.
    
    This library provides browser automation capabilities that work entirely in the browser
    without requiring Selenium or external drivers.
    """
    
    ROBOT_LIBRARY_SCOPE = 'GLOBAL'
    ROBOT_LIBRARY_VERSION = '1.0.0'
    
    @keyword('Click Element')
    def click_element(self, selector):
        """Click an element identified by CSS selector.
        
        Example:
        | Click Element | button#submit |
        """
        element = document.querySelector(selector)
        if not element:
            raise AssertionError(f"Element not found: {selector}")
        element.click()
        console.log(f"Clicked element: {selector}")
    
    @keyword('Input Text')
    def input_text(self, selector, text):
        """Input text into an element identified by CSS selector.
        
        Example:
        | Input Text | input#username | john_doe |
        """
        element = document.querySelector(selector)
        if not element:
            raise AssertionError(f"Element not found: {selector}")
        element.value = text
        # Trigger input event for frameworks like React/Vue
        event = js.Event.new('input', {'bubbles': True})
        element.dispatchEvent(event)
        console.log(f"Input text into {selector}: {text}")
    
    @keyword('Element Should Be Visible')
    def element_should_be_visible(self, selector):
        """Verify that element is visible on the page.
        
        Example:
        | Element Should Be Visible | div#welcome |
        """
        element = document.querySelector(selector)
        if not element:
            raise AssertionError(f"Element not found: {selector}")
        
        style = window.getComputedStyle(element)
        if style.display == 'none' or style.visibility == 'hidden':
            raise AssertionError(f"Element is not visible: {selector}")
        console.log(f"Element is visible: {selector}")
    
    @keyword('Element Should Contain')
    def element_should_contain(self, selector, text):
        """Verify that element contains expected text.
        
        Example:
        | Element Should Contain | h1 | Welcome |
        """
        element = document.querySelector(selector)
        if not element:
            raise AssertionError(f"Element not found: {selector}")
        
        if text not in element.textContent:
            raise AssertionError(f"Element '{selector}' does not contain '{text}'. Actual: {element.textContent}")
        console.log(f"Element {selector} contains: {text}")
    
    @keyword('Get Text')
    def get_text(self, selector):
        """Get text content of an element.
        
        Example:
        | \${text}= | Get Text | h1 |
        """
        element = document.querySelector(selector)
        if not element:
            raise AssertionError(f"Element not found: {selector}")
        return element.textContent
    
    @keyword('Get Value')
    def get_value(self, selector):
        """Get value of an input element.
        
        Example:
        | \${value}= | Get Value | input#username |
        """
        element = document.querySelector(selector)
        if not element:
            raise AssertionError(f"Element not found: {selector}")
        return element.value
    
    @keyword('Page Should Contain')
    def page_should_contain(self, text):
        """Verify that page contains expected text.
        
        Example:
        | Page Should Contain | Welcome to our site |
        """
        if text not in document.body.textContent:
            raise AssertionError(f"Page does not contain: {text}")
        console.log(f"Page contains: {text}")
    
    @keyword('Element Should Exist')
    def element_should_exist(self, selector):
        """Verify that element exists on the page.
        
        Example:
        | Element Should Exist | button#submit |
        """
        element = document.querySelector(selector)
        if not element:
            raise AssertionError(f"Element does not exist: {selector}")
        console.log(f"Element exists: {selector}")
    
    @keyword('Wait For Element')
    def wait_for_element(self, selector, timeout=5):
        """Wait for element to appear on the page.
        
        Example:
        | Wait For Element | div#results | timeout=10 |
        """
        import time
        start_time = time.time()
        timeout = float(timeout)
        
        while time.time() - start_time < timeout:
            element = document.querySelector(selector)
            if element:
                console.log(f"Element found: {selector}")
                return
            time.sleep(0.1)
        
        raise AssertionError(f"Element not found after {timeout}s: {selector}")
    
    @keyword('Select From List')
    def select_from_list(self, selector, value):
        """Select option from dropdown list.
        
        Example:
        | Select From List | select#country | USA |
        """
        element = document.querySelector(selector)
        if not element:
            raise AssertionError(f"Element not found: {selector}")
        
        element.value = value
        event = js.Event.new('change', {'bubbles': True})
        element.dispatchEvent(event)
        console.log(f"Selected '{value}' from {selector}")
    
    @keyword('Check Checkbox')
    def check_checkbox(self, selector):
        """Check a checkbox.
        
        Example:
        | Check Checkbox | input#terms |
        """
        element = document.querySelector(selector)
        if not element:
            raise AssertionError(f"Element not found: {selector}")
        element.checked = True
        event = js.Event.new('change', {'bubbles': True})
        element.dispatchEvent(event)
        console.log(f"Checked checkbox: {selector}")
    
    @keyword('Uncheck Checkbox')
    def uncheck_checkbox(self, selector):
        """Uncheck a checkbox.
        
        Example:
        | Uncheck Checkbox | input#newsletter |
        """
        element = document.querySelector(selector)
        if not element:
            raise AssertionError(f"Element not found: {selector}")
        element.checked = False
        event = js.Event.new('change', {'bubbles': True})
        element.dispatchEvent(event)
        console.log(f"Unchecked checkbox: {selector}")
    
    @keyword('Get Element Count')
    def get_element_count(self, selector):
        """Get count of elements matching selector.
        
        Example:
        | \${count}= | Get Element Count | div.item |
        """
        elements = document.querySelectorAll(selector)
        return len(elements)
    
    @keyword('Execute JavaScript')
    def execute_javascript(self, script):
        """Execute JavaScript code.
        
        Example:
        | Execute JavaScript | alert('Hello') |
        """
        return js.eval(script)
`);
                
                robotFrameworkInstalled = true;
                showMessage('Robot Framework + BrowserLibrary installed successfully!', 'success');
                return true;
            } catch (error) {
                console.error('Failed to install Robot Framework:', error);
                showMessage('Failed to install Robot Framework: ' + error.message, 'error');
                throw error;
            }
        }

        async function executePythonCode(code, inputFiles) {
            try {
                const pyodide = await initializePyodide();
                
                // Get Python's current working directory and write files there
                const cwd = pyodide.runPython('import os; os.getcwd()');
                
                // Create a virtual filesystem with input files in the working directory
                for (const file of inputFiles) {
                    const filePath = `${cwd}/${file.filename}`;
                    pyodide.FS.writeFile(filePath, file.content);
                }
                
                // Capture stdout
                let output = '';
                pyodide.runPython(`
import sys
from io import StringIO
sys.stdout = StringIO()
sys.stderr = StringIO()
`);
                
                // Run the code
                try {
                    await pyodide.runPythonAsync(code);
                    
                    // Get output
                    output = pyodide.runPython(`
stdout_value = sys.stdout.getvalue()
stderr_value = sys.stderr.getvalue()
stdout_value + stderr_value
`);
                } catch (execError) {
                    output = pyodide.runPython(`sys.stderr.getvalue()`) || execError.message;
                    throw new Error(output);
                }
                
                return {
                    success: true,
                    output: output,
                    error: null
                };
                
            } catch (error) {
                return {
                    success: false,
                    output: error.output || '',
                    error: error.message
                };
            }
        }

        async function executeRobotFrameworkBrowser(code) {
            if (!robotFrameworkInstalled) {
                await installRobotFramework();
            }
            
            try {
                const pyodide = await initializePyodide();
                
                // Create a temporary robot file in Pyodide's virtual filesystem
                const tempFileName = 'test_suite.robot';
                
                await pyodide.runPythonAsync(`
import sys
from io import StringIO
from robot import run

# Setup output capture
sys.stdout = StringIO()
sys.stderr = StringIO()

# Write robot file
with open('${tempFileName}', 'w') as f:
    f.write("""${code.replace(/"/g, '\\"').replace(/\n/g, '\\n')}""")

# Run robot tests with BrowserLibrary available
try:
    # Register BrowserLibrary
    from robot.libraries import STDLIBS
    # Note: BrowserLibrary is already defined globally from installation
    
    result = run('${tempFileName}', outputdir='NONE', output='NONE', log='NONE', report='NONE')
    output = sys.stdout.getvalue()
    error = sys.stderr.getvalue()
    success = (result == 0)
except Exception as e:
    output = sys.stdout.getvalue()
    error = str(e) + "\\n" + sys.stderr.getvalue()
    success = False
    result = -1
                `);
                
                const success = await pyodide.runPythonAsync('success');
                const output = await pyodide.runPythonAsync('output');
                const error = await pyodide.runPythonAsync('error');
                const exitCode = await pyodide.runPythonAsync('result');
                
                return {
                    success: success,
                    output: output || '(Robot Framework execution completed)',
                    error: error || null,
                    exitCode: exitCode
                };
            } catch (error) {
                return {
                    success: false,
                    output: null,
                    error: error.message,
                    exitCode: -1
                };
            }
        }

        async function executeRobotFrameworkBackend(code) {
            const backendUrl = executionConfig.robotBackendUrl || 'http://localhost:5000';
            
            try {
                const response = await fetch(`${backendUrl}/execute`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ code: code })
                });

                const result = await response.json();
                
                return {
                    success: result.success || false,
                    output: result.output || '',
                    error: result.error || null,
                    exitCode: result.exitCode || -1
                };
            } catch (error) {
                return {
                    success: false,
                    output: '',
                    error: `Failed to connect to backend server: ${error.message}`,
                    exitCode: -1
                };
            }
        }

        async function executeRobotFrameworkApi(code) {
            const apiUrl = executionConfig.robotApiUrl;
            
            if (!apiUrl) {
                return {
                    success: false,
                    output: '',
                    error: 'Robot Framework API URL not configured',
                    exitCode: -1
                };
            }
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ code: code })
                });

                const result = await response.json();
                
                return {
                    success: result.success || false,
                    output: result.output || '',
                    error: result.error || null,
                    exitCode: result.exitCode || -1
                };
            } catch (error) {
                return {
                    success: false,
                    output: '',
                    error: `API request failed: ${error.message}`,
                    exitCode: -1
                };
            }
        }

        async function executeJavaCode(code, inputFiles) {
            if (!executionConfig.javaType || executionConfig.javaType === 'jdoodle') {
                if (!executionConfig.jdoodleClientId || !executionConfig.jdoodleClientSecret) {
                    throw new Error("JDoodle API credentials not configured. Please go to Execution Settings.");
                }
                
                return await executeViaJDoodle('java', code, inputFiles);
            } else {
                throw new Error("Local Java execution requires a backend server. This feature is not yet implemented.");
            }
        }

        async function executeCSharpCode(code, inputFiles) {
            if (!executionConfig.csharpType || executionConfig.csharpType === 'jdoodle') {
                if (!executionConfig.jdoodleClientId || !executionConfig.jdoodleClientSecret) {
                    throw new Error("JDoodle API credentials not configured. Please go to Execution Settings.");
                }
                
                return await executeViaJDoodle('csharp', code, inputFiles);
            } else {
                throw new Error("Local C# execution requires a backend server. This feature is not yet implemented.");
            }
        }

        async function executeViaJDoodle(language, code, inputFiles) {
            // Prepare stdin (concatenate all input files)
            const stdin = inputFiles.map(f => f.content).join('\n');
            
            const payload = {
                clientId: executionConfig.jdoodleClientId,
                clientSecret: executionConfig.jdoodleClientSecret,
                script: code,
                stdin: stdin,
                language: language === 'java' ? 'java' : 'csharp',
                versionIndex: "0"
            };

            try {
                const response = await fetch('https://api.jdoodle.com/v1/execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                
                if (result.error) {
                    return {
                        success: false,
                        output: result.output || '',
                        error: result.error
                    };
                }

                return {
                    success: !result.statusCode || result.statusCode === 200,
                    output: result.output || '',
                    error: result.statusCode && result.statusCode !== 200 ? `Exit code: ${result.statusCode}` : null
                };
            } catch (error) {
                return {
                    success: false,
                    output: '',
                    error: error.message
                };
            }
        }

        function loadExecutionConfig() {
            const saved = localStorage.getItem('execution_config');
            if (saved) {
                executionConfig = JSON.parse(saved);
            } else {
                executionConfig = {
                    mode: 'real',
                    javaType: 'jdoodle',
                    csharpType: 'jdoodle',
                    jdoodleClientId: '',
                    jdoodleClientSecret: '',
                    robotType: 'browser',
                    robotBackendUrl: 'http://localhost:5000',
                    robotApiUrl: ''
                };
            }
            updateExecutionDisplay();
        }

        function updateExecutionDisplay() {
            const modeText = executionConfig.mode === 'real' ? 'Real Execution' : 'Simulated';
            const modeClass = executionConfig.mode === 'real' ? 'text-green-400' : 'text-yellow-400';
            document.getElementById('exec-mode-display').innerHTML = `<span class="${modeClass}">${modeText}</span>`;
        }

        function openExecutionSettingsModal() {
            // Safely set radio buttons with null checks
            const execModeRadio = document.querySelector(`input[name="execution-mode"][value="${executionConfig.mode}"]`);
            if (execModeRadio) execModeRadio.checked = true;
            
            const javaTypeRadio = document.querySelector(`input[name="java-execution-type"][value="${executionConfig.javaType}"]`);
            if (javaTypeRadio) javaTypeRadio.checked = true;
            
            const csharpTypeRadio = document.querySelector(`input[name="csharp-execution-type"][value="${executionConfig.csharpType}"]`);
            if (csharpTypeRadio) csharpTypeRadio.checked = true;
            
            const robotTypeRadio = document.querySelector(`input[name="robot-execution-type"][value="${executionConfig.robotType}"]`);
            if (robotTypeRadio) robotTypeRadio.checked = true;
            
            const jdoodleClientId = document.getElementById('jdoodle-client-id');
            if (jdoodleClientId) jdoodleClientId.value = executionConfig.jdoodleClientId || '';
            
            const jdoodleClientSecret = document.getElementById('jdoodle-client-secret');
            if (jdoodleClientSecret) jdoodleClientSecret.value = executionConfig.jdoodleClientSecret || '';
            
            const robotBackendUrl = document.getElementById('robot-backend-url');
            if (robotBackendUrl) robotBackendUrl.value = executionConfig.robotBackendUrl || 'http://localhost:5000';
            
            const robotApiUrl = document.getElementById('robot-api-url');
            if (robotApiUrl) robotApiUrl.value = executionConfig.robotApiUrl || '';
            
            // Setup Robot Framework radio button handlers
            document.querySelectorAll('input[name="robot-execution-type"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const browserConfig = document.getElementById('robot-browser-config');
                    const backendConfig = document.getElementById('robot-backend-config');
                    const apiConfig = document.getElementById('robot-api-config');
                    
                    if (!browserConfig || !backendConfig || !apiConfig) return;
                    
                    if (this.value === 'browser') {
                        browserConfig.classList.remove('hidden');
                        backendConfig.classList.add('hidden');
                        apiConfig.classList.add('hidden');
                    } else if (this.value === 'backend') {
                        browserConfig.classList.add('hidden');
                        backendConfig.classList.remove('hidden');
                        apiConfig.classList.add('hidden');
                    } else {
                        browserConfig.classList.add('hidden');
                        backendConfig.classList.add('hidden');
                        apiConfig.classList.remove('hidden');
                    }
                });
            });
            
            // Trigger initial state
            const selectedRobotRadio = document.querySelector('input[name="robot-execution-type"]:checked');
            if (selectedRobotRadio) {
                const selectedRobot = selectedRobotRadio.value;
                const browserConfig = document.getElementById('robot-browser-config');
                const backendConfig = document.getElementById('robot-backend-config');
                const apiConfig = document.getElementById('robot-api-config');
                
                if (browserConfig && backendConfig && apiConfig) {
                    if (selectedRobot === 'browser') {
                        browserConfig.classList.remove('hidden');
                        backendConfig.classList.add('hidden');
                        apiConfig.classList.add('hidden');
                    } else if (selectedRobot === 'backend') {
                        browserConfig.classList.add('hidden');
                        backendConfig.classList.remove('hidden');
                        apiConfig.classList.add('hidden');
                    } else {
                        browserConfig.classList.add('hidden');
                        backendConfig.classList.add('hidden');
                        apiConfig.classList.remove('hidden');
                    }
                }
            }
            
            document.getElementById('execution-settings-modal').classList.remove('hidden');
        }

        function closeExecutionSettingsModal() {
            document.getElementById('execution-settings-modal').classList.add('hidden');
        }

        function saveExecutionSettings() {
            const execModeRadio = document.querySelector('input[name="execution-mode"]:checked');
            const javaTypeRadio = document.querySelector('input[name="java-execution-type"]:checked');
            const csharpTypeRadio = document.querySelector('input[name="csharp-execution-type"]:checked');
            const robotTypeRadio = document.querySelector('input[name="robot-execution-type"]:checked');
            
            if (execModeRadio) executionConfig.mode = execModeRadio.value;
            if (javaTypeRadio) executionConfig.javaType = javaTypeRadio.value;
            if (csharpTypeRadio) executionConfig.csharpType = csharpTypeRadio.value;
            if (robotTypeRadio) executionConfig.robotType = robotTypeRadio.value;
            
            const jdoodleClientId = document.getElementById('jdoodle-client-id');
            const jdoodleClientSecret = document.getElementById('jdoodle-client-secret');
            const robotBackendUrl = document.getElementById('robot-backend-url');
            const robotApiUrl = document.getElementById('robot-api-url');
            
            if (jdoodleClientId) executionConfig.jdoodleClientId = jdoodleClientId.value;
            if (jdoodleClientSecret) executionConfig.jdoodleClientSecret = jdoodleClientSecret.value;
            if (robotBackendUrl) executionConfig.robotBackendUrl = robotBackendUrl.value;
            if (robotApiUrl) executionConfig.robotApiUrl = robotApiUrl.value;
            
            localStorage.setItem('execution_config', JSON.stringify(executionConfig));
            updateExecutionDisplay();
            closeExecutionSettingsModal();
            showMessage("Execution settings saved", 'success');
        }

        // ============================================
        // STORAGE ABSTRACTION LAYER
        // ============================================
        
        let currentStorage = null;
        let storageConfig = null;
        
        // Storage Interface - all backends must implement these methods
        class StorageBackend {
            async initialize() { throw new Error("Not implemented"); }
            async getAllSuites() { throw new Error("Not implemented"); }
            async saveSuite(suite) { throw new Error("Not implemented"); }
            async updateSuite(id, suite) { throw new Error("Not implemented"); }
            async deleteSuite(id) { throw new Error("Not implemented"); }
            async subscribeToChanges(callback) { /* Optional */ }
            getStatusMessage() { return "Connected"; }
        }

        // ============================================
        // LOCAL STORAGE BACKEND
        // ============================================
        
        class LocalStorageBackend extends StorageBackend {
            constructor() {
                super();
                this.STORAGE_KEY = 'pipeline_test_suites';
                this.changeListeners = [];
            }

            async initialize() {
                if (!window.localStorage) {
                    throw new Error("localStorage is not available in this browser");
                }
                return true;
            }

            async getAllSuites() {
                const data = localStorage.getItem(this.STORAGE_KEY);
                return data ? JSON.parse(data) : [];
            }

            async saveSuite(suite) {
                const suites = await this.getAllSuites();
                suite.id = suite.id || this._generateId();
                suite.last_run_time = suite.last_run_time || null;
                suite.last_run_status = suite.last_run_status || 'NEVER_RUN';
                suite.last_run_log = suite.last_run_log || '';
                suites.push(suite);
                localStorage.setItem(this.STORAGE_KEY, JSON.stringify(suites));
                this._notifyListeners();
                return suite.id;
            }

            async updateSuite(id, updates) {
                const suites = await this.getAllSuites();
                const index = suites.findIndex(s => s.id === id);
                if (index !== -1) {
                    suites[index] = { ...suites[index], ...updates };
                    localStorage.setItem(this.STORAGE_KEY, JSON.stringify(suites));
                    this._notifyListeners();
                }
            }

            async deleteSuite(id) {
                const suites = await this.getAllSuites();
                const filtered = suites.filter(s => s.id !== id);
                localStorage.setItem(this.STORAGE_KEY, JSON.stringify(filtered));
                this._notifyListeners();
            }

            async subscribeToChanges(callback) {
                this.changeListeners.push(callback);
                const suites = await this.getAllSuites();
                callback(suites);
            }

            _notifyListeners() {
                const suites = JSON.parse(localStorage.getItem(this.STORAGE_KEY) || '[]');
                this.changeListeners.forEach(cb => cb(suites));
            }

            _generateId() {
                return 'local_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }

            getStatusMessage() {
                return `Connected: Local Storage (Browser Only)`;
            }
        }

        // ============================================
        // FIREBASE BACKEND
        // ============================================
        
        class FirebaseBackend extends StorageBackend {
            constructor(config) {
                super();
                this.config = config;
                this.app = null;
                this.db = null;
                this.auth = null;
                this.userId = null;
                this.unsubscribe = null;
            }

            async initialize() {
                try {
                    if (!window.firebaseModules) {
                        throw new Error("Firebase modules not loaded");
                    }

                    const { initializeApp, getFirestore, getAuth, signInAnonymously, onAuthStateChanged } = window.firebaseModules;
                    
                    this.app = initializeApp(this.config);
                    this.db = getFirestore(this.app);
                    this.auth = getAuth(this.app);

                    await signInAnonymously(this.auth);
                    
                    return new Promise((resolve, reject) => {
                        onAuthStateChanged(this.auth, (user) => {
                            if (user) {
                                this.userId = user.uid;
                                resolve(true);
                            } else {
                                reject(new Error("Authentication failed"));
                            }
                        });
                    });
                } catch (error) {
                    console.error("Firebase initialization error:", error);
                    throw error;
                }
            }

            async getAllSuites() {
                return [];
            }

            async saveSuite(suite) {
                const { collection, addDoc } = window.firebaseModules;
                suite.userId = this.userId;
                suite.last_run_time = suite.last_run_time || null;
                suite.last_run_status = suite.last_run_status || 'NEVER_RUN';
                suite.last_run_log = suite.last_run_log || '';
                
                const docRef = await addDoc(collection(this.db, 'test_suites'), suite);
                return docRef.id;
            }

            async updateSuite(id, updates) {
                const { doc, updateDoc } = window.firebaseModules;
                const docRef = doc(this.db, 'test_suites', id);
                await updateDoc(docRef, updates);
            }

            async deleteSuite(id) {
                const { doc, deleteDoc } = window.firebaseModules;
                const docRef = doc(this.db, 'test_suites', id);
                await deleteDoc(docRef);
            }

            async subscribeToChanges(callback) {
                const { collection, query, where, onSnapshot } = window.firebaseModules;
                const q = query(
                    collection(this.db, 'test_suites'),
                    where('userId', '==', this.userId)
                );
                
                this.unsubscribe = onSnapshot(q, (snapshot) => {
                    const suites = [];
                    snapshot.forEach((doc) => {
                        suites.push({ id: doc.id, ...doc.data() });
                    });
                    callback(suites);
                });
            }

            getStatusMessage() {
                return `Connected: Firebase (User: ${this.userId ? this.userId.substring(0, 8) + '...' : 'Unknown'})`;
            }
        }

        // ============================================
        // CUSTOM API BACKEND
        // ============================================
        
        class CustomApiBackend extends StorageBackend {
            constructor(config) {
                super();
                this.baseUrl = config.baseUrl;
                this.authHeader = config.authHeader;
                this.pollInterval = null;
            }

            async initialize() {
                try {
                    await this._fetch('GET', '');
                    return true;
                } catch (error) {
                    throw new Error(`Cannot connect to API: ${error.message}`);
                }
            }

            async getAllSuites() {
                const response = await this._fetch('GET', '');
                return response;
            }

            async saveSuite(suite) {
                suite.last_run_time = suite.last_run_time || null;
                suite.last_run_status = suite.last_run_status || 'NEVER_RUN';
                suite.last_run_log = suite.last_run_log || '';
                
                const response = await this._fetch('POST', '', suite);
                return response.id;
            }

            async updateSuite(id, updates) {
                await this._fetch('PUT', `/${id}`, updates);
            }

            async deleteSuite(id) {
                await this._fetch('DELETE', `/${id}`);
            }

            async subscribeToChanges(callback) {
                const poll = async () => {
                    try {
                        const suites = await this.getAllSuites();
                        callback(suites);
                    } catch (error) {
                        console.error("Polling error:", error);
                    }
                };
                
                await poll();
                this.pollInterval = setInterval(poll, 5000);
            }

            async _fetch(method, path, body = null) {
                const options = {
                    method,
                    headers: {
                        'Content-Type': 'application/json'
                    }
                };

                if (this.authHeader) {
                    options.headers['Authorization'] = this.authHeader;
                }

                if (body) {
                    options.body = JSON.stringify(body);
                }

                const response = await fetch(this.baseUrl + path, options);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                if (method !== 'DELETE') {
                    return await response.json();
                }
            }

            getStatusMessage() {
                return `Connected: Custom API (${this.baseUrl})`;
            }
        }

        // ============================================
        // STORAGE MANAGER
        // ============================================
        
        async function initializeStorage() {
            try {
                const savedConfig = localStorage.getItem('storage_config');
                if (savedConfig) {
                    storageConfig = JSON.parse(savedConfig);
                } else {
                    storageConfig = { type: 'localStorage' };
                    localStorage.setItem('storage_config', JSON.stringify(storageConfig));
                }

                await connectToStorage(storageConfig);
                
            } catch (error) {
                console.error("Storage initialization error:", error);
                showMessage("Failed to initialize storage: " + error.message, 'error');
                document.getElementById('storage-info').textContent = "Storage initialization failed. Click Settings to configure.";
            }
        }

        async function connectToStorage(config) {
            try {
                switch (config.type) {
                    case 'localStorage':
                        currentStorage = new LocalStorageBackend();
                        break;
                    
                    case 'firebase':
                        if (!config.firebaseConfig) {
                            throw new Error("Firebase configuration is missing");
                        }
                        currentStorage = new FirebaseBackend(config.firebaseConfig);
                        break;
                    
                    case 'customApi':
                        if (!config.apiConfig) {
                            throw new Error("API configuration is missing");
                        }
                        currentStorage = new CustomApiBackend(config.apiConfig);
                        break;
                    
                    default:
                        throw new Error("Unknown storage type: " + config.type);
                }

                document.getElementById('storage-info').textContent = "Connecting to storage...";
                await currentStorage.initialize();
                await currentStorage.subscribeToChanges(renderTestSuites);
                document.getElementById('storage-info').textContent = currentStorage.getStatusMessage();
                showMessage("Storage connected successfully", 'success');
                
            } catch (error) {
                console.error("Storage connection error:", error);
                currentStorage = null;
                throw error;
            }
        }

        // ============================================
        // SETTINGS MODAL
        // ============================================
        
        function openSettingsModal() {
            if (storageConfig) {
                const storageTypeRadio = document.querySelector(`input[name="storage-type"][value="${storageConfig.type}"]`);
                if (storageTypeRadio) storageTypeRadio.checked = true;
                
                if (storageConfig.type === 'firebase' && storageConfig.firebaseConfig) {
                    const fc = storageConfig.firebaseConfig;
                    const fbApiKey = document.getElementById('firebase-api-key');
                    const fbAuthDomain = document.getElementById('firebase-auth-domain');
                    const fbProjectId = document.getElementById('firebase-project-id');
                    const fbStorageBucket = document.getElementById('firebase-storage-bucket');
                    
                    if (fbApiKey) fbApiKey.value = fc.apiKey || '';
                    if (fbAuthDomain) fbAuthDomain.value = fc.authDomain || '';
                    if (fbProjectId) fbProjectId.value = fc.projectId || '';
                    if (fbStorageBucket) fbStorageBucket.value = fc.storageBucket || '';
                }
                
                if (storageConfig.type === 'customApi' && storageConfig.apiConfig) {
                    const ac = storageConfig.apiConfig;
                    const apiBaseUrl = document.getElementById('api-base-url');
                    const apiAuthHeader = document.getElementById('api-auth-header');
                    
                    if (apiBaseUrl) apiBaseUrl.value = ac.baseUrl || '';
                    if (apiAuthHeader) apiAuthHeader.value = ac.authHeader || '';
                }
            }
            
            // Setup storage type radio handlers
            document.querySelectorAll('input[name="storage-type"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const firebaseConfig = document.getElementById('firebase-config');
                    const customApiConfig = document.getElementById('custom-api-config');
                    
                    if (!firebaseConfig || !customApiConfig) return;
                    
                    firebaseConfig.classList.add('hidden');
                    customApiConfig.classList.add('hidden');
                    
                    if (this.value === 'firebase') {
                        firebaseConfig.classList.remove('hidden');
                    } else if (this.value === 'customApi') {
                        customApiConfig.classList.remove('hidden');
                    }
                });
            });
            
            // Trigger initial state
            const selectedTypeRadio = document.querySelector('input[name="storage-type"]:checked');
            if (selectedTypeRadio) {
                const selectedType = selectedTypeRadio.value;
                const firebaseConfig = document.getElementById('firebase-config');
                const customApiConfig = document.getElementById('custom-api-config');
                
                if (firebaseConfig && customApiConfig) {
                    if (selectedType === 'firebase') {
                        firebaseConfig.classList.remove('hidden');
                    } else if (selectedType === 'customApi') {
                        customApiConfig.classList.remove('hidden');
                    }
                }
            }
            
            document.getElementById('settings-modal').classList.remove('hidden');
        }

        function closeSettingsModal() {
            document.getElementById('settings-modal').classList.add('hidden');
        }

        async function saveSettings() {
            const storageTypeRadio = document.querySelector('input[name="storage-type"]:checked');
            if (!storageTypeRadio) {
                showMessage("Please select a storage type", 'error');
                return;
            }
            
            const newConfig = {
                type: storageTypeRadio.value
            };
            
            if (newConfig.type === 'firebase') {
                const fbApiKey = document.getElementById('firebase-api-key');
                const fbAuthDomain = document.getElementById('firebase-auth-domain');
                const fbProjectId = document.getElementById('firebase-project-id');
                const fbStorageBucket = document.getElementById('firebase-storage-bucket');
                
                newConfig.firebaseConfig = {
                    apiKey: fbApiKey ? fbApiKey.value : '',
                    authDomain: fbAuthDomain ? fbAuthDomain.value : '',
                    projectId: fbProjectId ? fbProjectId.value : '',
                    storageBucket: fbStorageBucket ? fbStorageBucket.value : ''
                };
                
                if (!newConfig.firebaseConfig.apiKey || !newConfig.firebaseConfig.projectId) {
                    showMessage("Please fill in Firebase credentials", 'error');
                    return;
                }
            } else if (newConfig.type === 'customApi') {
                const apiBaseUrl = document.getElementById('api-base-url');
                const apiAuthHeader = document.getElementById('api-auth-header');
                
                newConfig.apiConfig = {
                    baseUrl: apiBaseUrl ? apiBaseUrl.value : '',
                    authHeader: apiAuthHeader ? apiAuthHeader.value : ''
                };
                
                if (!newConfig.apiConfig.baseUrl) {
                    showMessage("Please enter API base URL", 'error');
                    return;
                }
            }
            
            try {
                localStorage.setItem('storage_config', JSON.stringify(newConfig));
                storageConfig = newConfig;
                await connectToStorage(newConfig);
                closeSettingsModal();
            } catch (error) {
                showMessage("Failed to connect: " + error.message, 'error');
            }
        }

        // ============================================
        // TEST SUITE RENDERING
        // ============================================
        
        let testSuites = [];
        let editingSuiteId = null;

        function renderTestSuites(suites) {
            testSuites = suites;
            const container = document.getElementById('test-suites');
            const loadingMsg = document.getElementById('loading-message');
            if (loadingMsg) loadingMsg.remove();
            
            if (suites.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No test suites configured. Click "Add New Test Suite" to get started.</p>';
                return;
            }
            
            container.innerHTML = suites.map(suite => {
                const statusClass = suite.last_run_status === 'SUCCESS' ? 'text-green-400' : 
                                  suite.last_run_status === 'FAILURE' ? 'text-red-400' : 'text-gray-500';
                return `
                    <div class="bg-gray-800 p-6 rounded-lg border-l-4 border-emerald-500 shadow-lg">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex-1">
                                <h3 class="text-xl font-bold text-white mb-2">${escapeHtml(suite.name)}</h3>
                                <p class="text-gray-400 text-sm">${escapeHtml(suite.description || 'No description')}</p>
                            </div>
                            <div class="flex flex-col items-end space-y-2">
                                <span class="px-3 py-1 text-xs font-semibold bg-emerald-600 text-white rounded-full">
                                    ${suite.language.toUpperCase()}
                                </span>
                                ${suite.last_run_status && suite.last_run_status !== 'NEVER_RUN' ? `
                                    <span class="px-3 py-1 text-xs font-semibold rounded-full ${statusClass}">
                                        ${suite.last_run_status}
                                    </span>
                                ` : ''}
                            </div>
                        </div>
                        
                        ${suite.last_run_time ? `
                            <div class="text-xs text-gray-500 mb-3">
                                Last run: ${new Date(suite.last_run_time).toLocaleString()}
                            </div>
                        ` : ''}
                        
                        <div class="flex justify-end space-x-2">
                            <button onclick="runTestSuite('${suite.id}')" 
                                class="bg-green-600 hover:bg-green-500 text-white text-sm font-semibold py-1 px-3 rounded transition">
                                ‚ñ∂ Run
                            </button>
                            <button onclick="editSuite('${suite.id}')" 
                                class="bg-blue-600 hover:bg-blue-500 text-white text-sm font-semibold py-1 px-3 rounded transition">
                                Edit
                            </button>
                            <button onclick="deleteSuite('${suite.id}')" 
                                class="bg-red-600 hover:bg-red-500 text-white text-sm font-semibold py-1 px-3 rounded transition">
                                Delete
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function openAddSuiteModal() {
            if (!currentStorage) {
                showMessage("Please configure storage first (click Settings)", 'error');
                return;
            }
            
            editingSuiteId = null;
            document.getElementById('modal-title').textContent = 'Add New Test Suite';
            document.getElementById('suite-form').reset();
            document.getElementById('suite-id').value = '';
            document.getElementById('parameters-container').innerHTML = '';
            document.getElementById('input-files-container').innerHTML = '';
            document.getElementById('enable_log_saving').checked = false;
            document.getElementById('log-config-options').classList.add('hidden');
            
            document.getElementById('editor-modal').classList.remove('hidden');
        }

        function closeEditorModal() {
            document.getElementById('editor-modal').classList.add('hidden');
        }

        function editSuite(suiteId) {
            editingSuiteId = suiteId;
            const suite = testSuites.find(s => s.id === suiteId);
            if (!suite) return;
            
            document.getElementById('modal-title').textContent = 'Edit Test Suite';
            document.getElementById('suite-id').value = suiteId;
            document.getElementById('name').value = suite.name;
            document.getElementById('description').value = suite.description || '';
            document.getElementById('language').value = suite.language;
            document.getElementById('code').value = suite.code || '';
            document.getElementById('webhook_url').value = suite.webhook_url || '';
            document.getElementById('integration_info').value = suite.integration_info || '';
            
            const paramsContainer = document.getElementById('parameters-container');
            paramsContainer.innerHTML = '';
            if (suite.parameters && suite.parameters.length > 0) {
                suite.parameters.forEach(param => {
                    addParameterInput(param.key, param.value);
                });
            }
            
            const filesContainer = document.getElementById('input-files-container');
            filesContainer.innerHTML = '';
            if (suite.inputFiles && suite.inputFiles.length > 0) {
                suite.inputFiles.forEach(file => {
                    addInputFile(file.filename, file.content);
                });
            }
            
            // Load log configuration
            if (suite.log_config) {
                document.getElementById('enable_log_saving').checked = suite.log_config.enabled || false;
                document.getElementById('log_filename').value = suite.log_config.filename || 'log_{suite_name}_{timestamp}';
                document.getElementById('log_format').value = suite.log_config.format || 'txt';
                document.getElementById('log_save_trigger').value = suite.log_config.save_trigger || 'always';
                document.getElementById('log-config-options').classList.toggle('hidden', !suite.log_config.enabled);
            } else {
                document.getElementById('enable_log_saving').checked = false;
                document.getElementById('log-config-options').classList.add('hidden');
            }
            
            document.getElementById('editor-modal').classList.remove('hidden');
        }

        async function handleSave(event) {
            event.preventDefault();
            
            if (!currentStorage) {
                showMessage("Storage not initialized", 'error');
                return;
            }
            
            const suite = {
                name: document.getElementById('name').value,
                description: document.getElementById('description').value,
                language: document.getElementById('language').value,
                code: document.getElementById('code').value,
                webhook_url: document.getElementById('webhook_url').value,
                integration_info: document.getElementById('integration_info').value,
                parameters: getParametersFromForm(),
                inputFiles: getInputFilesFromForm(),
                execution_mode: executionConfig.mode,
                log_config: {
                    enabled: document.getElementById('enable_log_saving').checked,
                    filename: document.getElementById('log_filename').value,
                    format: document.getElementById('log_format').value,
                    save_trigger: document.getElementById('log_save_trigger').value
                }
            };
            
            try {
                if (editingSuiteId) {
                    await currentStorage.updateSuite(editingSuiteId, suite);
                    showMessage("Test suite updated successfully", 'success');
                } else {
                    await currentStorage.saveSuite(suite);
                    showMessage("Test suite created successfully", 'success');
                }
                closeEditorModal();
            } catch (error) {
                console.error("Save error:", error);
                showMessage("Failed to save: " + error.message, 'error');
            }
        }

        async function deleteSuite(suiteId) {
            if (!confirm('Are you sure you want to delete this test suite?')) {
                return;
            }
            
            try {
                await currentStorage.deleteSuite(suiteId);
                showMessage("Test suite deleted", 'success');
            } catch (error) {
                console.error("Delete error:", error);
                showMessage("Failed to delete: " + error.message, 'error');
            }
        }

        // ============================================
        // PARAMETERS & INPUT FILES
        // ============================================
        
        function addParameterInput(key = '', value = '') {
            const container = document.getElementById('parameters-container');
            const id = 'param-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            
            const div = document.createElement('div');
            div.className = 'flex space-x-2';
            div.id = id;
            div.innerHTML = `
                <input type="text" placeholder="Key" value="${escapeHtml(key)}" 
                    class="flex-1 bg-gray-700 border border-gray-600 text-white p-2 rounded text-sm">
                <input type="text" placeholder="Value" value="${escapeHtml(value)}" 
                    class="flex-1 bg-gray-700 border border-gray-600 text-white p-2 rounded text-sm">
                <button type="button" onclick="document.getElementById('${id}').remove()" 
                    class="bg-red-600 hover:bg-red-500 text-white px-3 rounded text-sm">√ó</button>
            `;
            container.appendChild(div);
        }

        function getParametersFromForm() {
            const container = document.getElementById('parameters-container');
            const params = [];
            container.querySelectorAll('div').forEach(div => {
                const inputs = div.querySelectorAll('input[type="text"]');
                if (inputs.length === 2 && inputs[0].value && inputs[1].value) {
                    params.push({
                        key: inputs[0].value,
                        value: inputs[1].value
                    });
                }
            });
            return params;
        }

        function addInputFile(filename = '', content = '') {
            const container = document.getElementById('input-files-container');
            const id = 'file-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            const fileInputId = 'file-input-' + id;
            
            const div = document.createElement('div');
            div.className = 'p-3 bg-gray-700 rounded border border-gray-600';
            div.id = id;
            div.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <input type="text" id="${id}-filename" placeholder="Filename (e.g., test_data.csv)" value="${escapeHtml(filename)}" 
                        class="flex-1 bg-gray-800 border border-gray-600 text-white p-2 rounded text-sm mr-2">
                    <label for="${fileInputId}" 
                        class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1 rounded text-sm cursor-pointer whitespace-nowrap mr-2">
                        Browse...
                    </label>
                    <input type="file" id="${fileInputId}" class="hidden">
                    <button type="button" onclick="document.getElementById('${id}').remove()" 
                        class="bg-red-600 hover:bg-red-500 text-white px-3 py-1 rounded text-sm">Remove</button>
                </div>
                <textarea id="${id}-content" placeholder="File content (or click Browse to load a file)..." rows="3" 
                    class="w-full bg-gray-800 border border-gray-600 text-white p-2 rounded text-sm font-mono">${escapeHtml(content)}</textarea>
                <div id="${id}-file-info" class="text-xs text-gray-400 mt-1"></div>
            `;
            container.appendChild(div);
            
            const fileInput = document.getElementById(fileInputId);
            fileInput.addEventListener('change', function(e) {
                handleFileLoad(e, id);
            });
        }
        
        function handleFileLoad(event, containerId) {
            const file = event.target.files[0];
            if (!file) return;
            
            const filenameInput = document.getElementById(`${containerId}-filename`);
            const contentTextarea = document.getElementById(`${containerId}-content`);
            const fileInfo = document.getElementById(`${containerId}-file-info`);
            
            filenameInput.value = file.name;
            fileInfo.textContent = `Loading ${file.name}...`;
            
            const reader = new FileReader();
            
            const isBinary = file.type.startsWith('image/') || 
                            file.type.startsWith('video/') || 
                            file.type.startsWith('audio/') ||
                            file.name.match(/\.(exe|bin|zip|tar|gz|pdf|doc|docx|xls|xlsx)$/i);
            
            reader.onload = function(e) {
                if (isBinary) {
                    const base64 = btoa(
                        new Uint8Array(e.target.result)
                            .reduce((data, byte) => data + String.fromCharCode(byte), '')
                    );
                    contentTextarea.value = `[Binary file - Base64 encoded]\n${base64}`;
                    fileInfo.innerHTML = `Loaded: <strong>${file.name}</strong> (${formatFileSize(file.size)}) - Binary file encoded as Base64`;
                } else {
                    contentTextarea.value = e.target.result;
                    fileInfo.innerHTML = `Loaded: <strong>${file.name}</strong> (${formatFileSize(file.size)})`;
                }
            };
            
            reader.onerror = function() {
                fileInfo.innerHTML = `Error loading file: ${file.name}`;
                contentTextarea.value = '';
            };
            
            if (isBinary) {
                reader.readAsArrayBuffer(file);
            } else {
                reader.readAsText(file);
            }
            
            event.target.value = '';
        }
        
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
        }

        function getInputFilesFromForm() {
            const container = document.getElementById('input-files-container');
            const files = [];
            container.querySelectorAll('div[id^="file-"]').forEach(div => {
                const id = div.id;
                const filenameInput = document.getElementById(`${id}-filename`);
                const contentTextarea = document.getElementById(`${id}-content`);
                
                if (filenameInput && contentTextarea) {
                    const filename = filenameInput.value;
                    const content = contentTextarea.value;
                    
                    if (filename && content) {
                        files.push({ filename, content });
                    }
                }
            });
            return files;
        }


        // ============================================
        // LOG FILE MANAGEMENT
        // ============================================
        
        let currentLogData = null;
        let currentSuiteForLog = null;
        
        function formatLogFilename(pattern, suite, status) {
            const now = new Date();
            const timestamp = now.getTime();
            const date = now.toISOString().split('T')[0];
            const time = now.toTimeString().split(' ')[0].replace(/:/g, '-');
            
            return pattern
                .replace('{suite_name}', suite.name.replace(/[^a-zA-Z0-9]/g, '_'))
                .replace('{timestamp}', timestamp)
                .replace('{date}', date)
                .replace('{time}', time)
                .replace('{status}', status.toLowerCase());
        }
        
        function formatLogContent(logText, format, suite, status) {
            const now = new Date();
            
            switch(format) {
                case 'json':
                    return JSON.stringify({
                        suite_name: suite.name,
                        description: suite.description,
                        language: suite.language,
                        timestamp: now.toISOString(),
                        status: status,
                        execution_mode: executionConfig.mode,
                        parameters: suite.parameters || [],
                        log: logText
                    }, null, 2);
                
                case 'html':
                    return `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Test Log - ${suite.name}</title>
    <style>
        body { font-family: 'Courier New', monospace; background: #1a1a1a; color: #00ff00; padding: 20px; }
        .header { background: #2d2d2d; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .header h1 { margin: 0; color: #00ff00; }
        .header .meta { color: #888; font-size: 12px; margin-top: 10px; }
        .status-success { color: #00ff00; }
        .status-failure { color: #ff0000; }
        .log-content { background: #0d0d0d; padding: 15px; border-radius: 5px; white-space: pre-wrap; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìã Test Execution Log</h1>
        <div class="meta">
            <strong>Suite:</strong> ${suite.name}<br>
            <strong>Language:</strong> ${suite.language}<br>
            <strong>Date:</strong> ${now.toLocaleString()}<br>
            <strong>Status:</strong> <span class="status-${status.toLowerCase()}">${status}</span>
        </div>
    </div>
    <div class="log-content">${logText.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>
</body>
</html>`;
                
                case 'xml':
                    return `<?xml version="1.0" encoding="UTF-8"?>
<test-execution>
    <suite name="${suite.name}" language="${suite.language}">
        <timestamp>${now.toISOString()}</timestamp>
        <status>${status}</status>
        <mode>${executionConfig.mode}</mode>
        <log><![CDATA[
${logText}
        ]]></log>
    </suite>
</test-execution>`;
                
                case 'md':
                    return `# Test Execution Log

**Suite:** ${suite.name}  
**Language:** ${suite.language}  
**Date:** ${now.toLocaleString()}  
**Status:** ${status}

## Execution Log

\`\`\`
${logText}
\`\`\`
`;
                
                default:
                    return logText;
            }
        }
        
        function autoSaveLogIfNeeded(suite, log, status) {
            if (!suite.log_config || !suite.log_config.enabled) {
                return;
            }
            
            const trigger = suite.log_config.save_trigger || 'always';
            
            let shouldSave = false;
            if (trigger === 'always') {
                shouldSave = true;
            } else if (trigger === 'failure' && status === 'FAILURE') {
                shouldSave = true;
            } else if (trigger === 'success' && status === 'SUCCESS') {
                shouldSave = true;
            }
            
            if (!shouldSave) return;
            
            const format = suite.log_config.format || 'txt';
            const extension = format === 'txt' ? 'txt' : format;
            const filename = formatLogFilename(suite.log_config.filename || 'log_{suite_name}_{timestamp}', suite, status) + '.' + extension;
            const content = formatLogContent(log, format, suite, status);
            
            // Trigger download
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function downloadCurrentLog() {
            if (!currentLogData || !currentSuiteForLog) {
                showMessage('No log data available', 'error');
                return;
            }
            
            const suite = currentSuiteForLog;
            const format = suite.log_config && suite.log_config.enabled ? suite.log_config.format : 'txt';
            const extension = format === 'txt' ? 'txt' : format;
            const filename = (suite.log_config && suite.log_config.enabled) 
                ? formatLogFilename(suite.log_config.filename, suite, currentLogData.status) + '.' + extension
                : `${suite.name.replace(/[^a-zA-Z0-9]/g, '_')}_${Date.now()}.txt`;
            
            const content = (suite.log_config && suite.log_config.enabled) 
                ? formatLogContent(currentLogData.log, format, suite, currentLogData.status)
                : currentLogData.log;
            
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
            
            showMessage('Log downloaded', 'success');
        }


        // ============================================
        // TEST EXECUTION
        // ============================================
        
        async function runTestSuite(suiteId) {
            const suite = testSuites.find(s => s.id === suiteId);
            if (!suite) {
                showMessage('Suite not found', 'error');
                return;
            }
            
            document.getElementById('run-modal').classList.remove('hidden');
            document.getElementById('run-modal-content').textContent = 'Initializing...';
            document.getElementById('run-status-indicator').innerHTML = '<span class="text-yellow-400"><div class="spinner"></div> Running...</span>';
            
            const startTime = new Date();
            let log = `=== PIPELINE EXECUTION LOG ===\n`;
            log += `Suite: ${suite.name}\n`;
            log += `Language: ${suite.language}\n`;
            log += `Mode: ${executionConfig.mode}\n`;
            log += `Started: ${formatTime(startTime)}\n`;
            log += `--- PIPELINE STARTED ---\n\n`;
            
            let status = 'SUCCESS';
            let executionOutput = '';
            
            if (executionConfig.mode === 'real') {
                log += `[EXECUTION] Running ${suite.language} code...\n\n`;
                document.getElementById('run-modal-content').textContent = log;
                
                try {
                    let result;
                    
                    if (suite.language === 'python') {
                        log += `[INFO] Initializing Python (Pyodide)...\n`;
                        document.getElementById('run-modal-content').textContent = log;
                        result = await executePythonCode(suite.code, suite.inputFiles || []);
                        
                    } else if (suite.language === 'robot') {
                        log += `[INFO] Initializing Robot Framework...\n`;
                        document.getElementById('run-modal-content').textContent = log;
                        
                        if (executionConfig.robotType === 'browser') {
                            result = await executeRobotFrameworkBrowser(suite.code);
                        } else if (executionConfig.robotType === 'backend') {
                            result = await executeRobotFrameworkBackend(suite.code);
                        } else {
                            result = await executeRobotFrameworkApi(suite.code);
                        }
                        
                    } else if (suite.language === 'java') {
                        log += `[INFO] Executing Java code...\n`;
                        document.getElementById('run-modal-content').textContent = log;
                        result = await executeJavaCode(suite.code, suite.inputFiles || []);
                        
                    } else if (suite.language === 'csharp') {
                        log += `[INFO] Executing C# code...\n`;
                        document.getElementById('run-modal-content').textContent = log;
                        result = await executeCSharpCode(suite.code, suite.inputFiles || []);
                        
                    } else {
                        throw new Error(`Unsupported language: ${suite.language}`);
                    }
                    
                    if (result.success) {
                        log += `[OUTPUT]\n${result.output}\n`;
                        if (result.error) {
                            log += `[STDERR]\n${result.error}\n`;
                        }
                        executionOutput = result.output;
                        
                        // Check for error indicators in output
                        const errorIndicators = ['error', 'exception', 'failed', 'failure'];
                        const hasErrorInOutput = errorIndicators.some(indicator => 
                            (result.output || '').toLowerCase().includes(indicator) || 
                            (result.error || '').toLowerCase().includes(indicator) ||
                            (result.output || '').includes(indicator)
                        );
                        
                        if (hasErrorInOutput) {
                            status = 'FAILURE';
                            log += `[WARNING] Error indicators detected in output despite successful execution.\n`;
                        }
                    } else {
                        log += `\n--- EXECUTION ERROR ---\n`;
                        log += result.error || 'Unknown error';
                        log += `\n--- END ERROR ---\n\n`;
                        status = 'FAILURE';
                        executionOutput = result.error;
                    }
                    
                } catch (error) {
                    log += `\n[ERROR] Execution failed: ${error.message}\n`;
                    status = 'FAILURE';
                    executionOutput = error.message;
                }
                
            } else {
                // Simulated mode
                log += `[CODE] Displaying code (simulation mode)...\n\n`;
                if (suite.code) {
                    log += suite.code.split('\n').map(line => `  ${line}`).join('\n');
                } else {
                    log += `  (no code defined)`;
                }
                log += `\n\n[RESULT] Simulated execution completed.\n`;
            }
            
            const endTime = new Date();
            const duration = ((endTime - startTime) / 1000).toFixed(2);
            
            log += `\n[STATUS] ${status}: ${status === 'SUCCESS' ? 'All tests passed.' : 'Execution encountered errors.'}\n\n`;
            log += `--- PIPELINE ENDED ---\n`;
            log += `Duration: ${duration}s. Final Status: ${status}`;
            
            document.getElementById('run-modal-content').textContent = log;
            document.getElementById('run-status-indicator').innerHTML = status === 'SUCCESS' ? 
                '<span class="text-green-400">Completed</span>' : 
                '<span class="text-red-400">Failed</span>';
            
            // Store log data for download
            currentLogData = { log: log, status: status };
            currentSuiteForLog = suite;
            
            // Auto-save log if configured
            autoSaveLogIfNeeded(suite, log, status);
            
            try {
                await currentStorage.updateSuite(suiteId, {
                    last_run_status: status,
                    last_run_time: new Date().toISOString(),
                    last_run_log: log
                });
            } catch (error) {
                console.error("Update error:", error);
                showMessage("Failed to update run status: " + error.message, 'error');
            }
        }

        function closeRunModal() {
            document.getElementById('run-modal').classList.add('hidden');
        }

        function formatTime(date) {
            return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }

        // ============================================
        // IMPORT/EXPORT
        // ============================================
        
        function exportToJSON() {
            const data = {
                exported_at: new Date().toISOString(),
                storage_type: storageConfig.type,
                execution_mode: executionConfig.mode,
                test_suites: testSuites
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pipeline_suites_export_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showMessage("Export completed", 'success');
        }

        function importFromJSON(event) {
            if (!currentStorage) {
                showMessage("Please configure storage first", 'error');
                event.target.value = null;
                return;
            }
            
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const content = JSON.parse(e.target.result);
                    let suitesToImport = [];
                    
                    if (content.test_suites && Array.isArray(content.test_suites)) {
                        suitesToImport = content.test_suites;
                    } else if (Array.isArray(content)) {
                        suitesToImport = content;
                    } else {
                        showMessage("Invalid JSON format", 'error');
                        return;
                    }
                    
                    if (suitesToImport.length === 0) {
                        showMessage("No test suites found in file", 'info');
                        return;
                    }
                    
                    let importCount = 0;
                    for (const suite of suitesToImport) {
                        try {
                            const { id, ...newSuite } = suite;
                            if (!newSuite.inputFiles) newSuite.inputFiles = [];
                            if (!newSuite.parameters) newSuite.parameters = [];
                            await currentStorage.saveSuite(newSuite);
                            importCount++;
                        } catch (error) {
                            console.error("Failed to import suite:", error);
                        }
                    }
                    
                    showMessage(`Imported ${importCount} test suite(s)`, 'success');
                    
                } catch (error) {
                    console.error("Import error:", error);
                    showMessage("Failed to import: " + error.message, 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = null;
        }

        // ============================================
        // UTILITIES
        // ============================================
        
        function showMessage(text, type = 'info') {
            const messageBox = document.getElementById('message-box');
            const colors = {
                success: 'bg-green-600',
                error: 'bg-red-600',
                info: 'bg-blue-600'
            };
            
            messageBox.className = `fixed top-5 right-5 z-50 transition-all duration-300 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg`;
            messageBox.textContent = text;
            messageBox.style.transform = 'translateX(0)';
            
            setTimeout(() => {
                messageBox.style.transform = 'translateX(150%)';
            }, 3000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        
        window.onload = async function() {
            loadExecutionConfig();
            await initializeStorage();
        };
    </script>
</body>
</html>
